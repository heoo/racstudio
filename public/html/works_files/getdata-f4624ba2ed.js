/*!***********************************************
 Copyright (c) 2019, Neusoft Inc.
 All rights reserved
 图表秀 Version 1.0.0 2020.4.24
 ************************************************/
"use strict";charting.constant("getDataConfig",{modes:["上传数据","数据库"],dsIdListRest:charts_server+"/service/charting/datasources",dsIdDataRest:charts_server+"/service/charting/querydata",excel:{url:charts_server+"/service/charting/resource/book/userdata",xhrFields:{withCredentials:!0},dataType:"json",autoUpload:!0,acceptFileTypes:/(\.|\/)(xls|xlsx|csv)$/i,maxFileSize:3145728},export:{action:charts_server+"/service/charting/resource/book/userdata/export"}}).service("getDataService",["$http","$q","getDataConfig",function(r,s,e){return{getDsIdList:function(e){var t=s.defer();return r({method:"get",url:e}).then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise},getDsIdData:function(e,t){var a=s.defer();return r({method:"post",url:e,data:t}).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}}]).controller("getDataCtrl",["getDataConfig","userDataService",function(e,t){var a=this;angular.extend(a,e),a.setOptions=function(e){if(!e)return;e=angular.extend({},e),angular.extend(a,e)}}]).directive("getData",["$rootScope","$timeout","$modal","getDataService","vipService","toaster",function(g,e,h,m,I,v){return{restrict:"EAC",controller:"getDataCtrl",controllerAs:"getData",templateUrl:"tpl/charting/getdata.html",scope:{config:"=getData",defaultDataQuery:"=defaultDataQuery",chartCompId:"="},link:function(l,e,t,r){var d={name:"Excel数据源",type:"excel",id:"excel"},n={name:"URL数据源",type:"url",id:"url"},o="excel",a="rdb",s="dataservices",i="url",c="ds_data_service",u="ds_url",y="sql",p="procedure",f="oData";l.data=null,l.showExecuteBotton=!0,l.dataQuery={dsId:"",dsInfo:null,query:{type:"sql",sql:"select ....."}},l.urlType={jsonArrays:"json_arrays",csv:"csv"},l.selectedUrlFormat=l.urlType.jsonArrays,l.selectedUrl=local_server+"/src/assets/chart/sample/"+l.chartCompId+"/1_0/sampleData.json",r.setOptions(l.config),$("#fileUpload").fileupload(r.excel).on("fileuploadadd",function(e,t){var a=t.originalFiles[0].name;if(!(l.fileName=a)||r.excel.acceptFileTypes.test(a.substring(a.lastIndexOf("."))))if(t.originalFiles[0].size&&t.originalFiles[0].size>r.excel.maxFileSize)v.pop("info","文件大小不能超过3M！");else{t.submit().success(function(e,t,a){if(e.error)v.pop("error","数据解析错误",e.error.m);else{for(var r=e.object||[],s=0;s<r.length;s++)for(var d=0;d<r[s].length;d++)r[s][d]=$("<div/>").text(r[s][d]).html();l.data=r,g.$broadcast("getData.dataSource",{data:l.data,dataQuery:null})}}).error(function(e,t,a){401===e.status?g.$emit("userIntercepted","notLogin",e):v.pop("error","数据解析错误",e.object.error.m)});l.$$phase||l.$digest()}else v.pop("info","不支持该格式数据，请上传excel或csv文件！")}),m.getDsIdList(r.dsIdListRest).then(function(e){l.dsIdList=[],l.dsIdList.unshift(d),l.dsIdList.push(n);var t=l.defaultDataQuery;t?t.dsInfo?(l.selectedDs=_.findWhere(l.dsIdList,{id:t.dsId}).name||null,l.selectedUrl=t.dsInfo.attributes.url||null,l.selectedType=t.dsInfo.type||null,l.selectedUrlFormat=t.dsInfo.attributes.format||null):t.query.type==y||t.query.type==p?(l.selectedDs=_.findWhere(l.dsIdList,{id:t.dsId}).name||null,l.selectedSql=t.query.sql||null,l.selectedType=t.query.type||null):t.query.type==f&&(l.selectedDs=_.findWhere(l.dsIdList,{id:t.dsId}).name||null,l.selectedResource=t.query.resource||null,l.selectedOption=t.query.options||null):(l.selectedDs=l.dsIdList[0].name,l.selectedType=l.dsIdList[0].type,l.showExecuteBotton=!1)},function(e){console.error(e)}),l.executeQuery=function(){l.selectedType!=o&&(l.selectedType==a?(l.dataQuery.dsId=_.findWhere(l.dsIdList,{name:l.selectedDs}).id,l.dataQuery.query.type=y,l.dataQuery.query.sql=l.selectedSql):l.selectedType==s?(l.dataQuery.dsId=_.findWhere(l.dsIdList,{name:l.selectedDs}).id,l.dataQuery.query.type=f,l.dataQuery.query.resource=l.selectedResource,l.dataQuery.query.options=l.selectedOption):l.selectedType==i?(l.dataQuery.dsId=_.findWhere(l.dsIdList,{name:l.selectedDs}).id,l.dataQuery.dsInfo={},l.dataQuery.dsInfo.attributes={},l.dataQuery.dsInfo.type=u,l.dataQuery.dsInfo.attributes.url=l.selectedUrl,l.dataQuery.dsInfo.attributes.format=l.selectedUrlFormat,l.dataQuery.query&&(l.dataQuery.query=null)):(l.dataQuery.dsId=_.findWhere(l.dsIdList,{name:l.selectedDs}).id,l.dataQuery.dsInfo={},l.dataQuery.dsInfo.attributes={},l.dataQuery.dsInfo.type=c,l.dataQuery.dsInfo.attributes.url=l.selectedUrl),m.getDsIdData(r.dsIdDataRest,l.dataQuery).then(function(e){if(e.data.error)v.pop("error","",e.data.error.m);else{var t=JSON.parse(e.data.object);0===t.length&&v.info("查询数据为空！"),g.$broadcast("getData.dataSource",{data:t,dataQuery:l.dataQuery})}}))},l.$watch("selectedDs",function(e,t){var a=5<=I.getVipLevel();if(l.selectedDs==n.name&&!a)return h.open({templateUrl:"tpl/security/limit_warning_modal.html",controller:"limitWarningModalCtrl",size:"sm",resolve:{params:function(){return angular.copy({titleMsg:"URL数据源为<"+I.vipClass[5].name+">及以上专享！",isShowGoPay:!0,isShowCancelBtn:!0})}}}),void(l.selectedDs=d.name);if(g.$$phase||g.$broadcast("data changed",{}),e){for(var r=0,s=l.dsIdList.length;r<s;r++)l.dsIdList[r].name==e&&(l.selectedType=l.dsIdList[r].type,l.showExecuteBotton=!(l.selectedType==o));g.$broadcast("getData.changeDs",{type:l.selectedType})}})}}}]);