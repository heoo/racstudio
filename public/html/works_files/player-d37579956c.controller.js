/*!***********************************************
 Copyright (c) 2019, Neusoft Inc.
 All rights reserved
 图表秀 Version 1.0.0 2020.4.24
 ************************************************/
"use strict";player.controller("playerCtrl",["$scope","$rootScope","$q","$http","$localStorage","$modal","$timeout","ngAudio","userDataService","themeService","toaster","chartEngineManager","CHART_V1","CHART_V2","WeixinSDK",function(n,h,r,c,e,d,t,o,u,i,l,a,s,g,p){var m,w,y,f,b={};function M(o){var t=r.defer(),e=""===o?{method:"GET",url:charts_server+"/service/user/limits",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}}:{method:"POST",url:charts_server+"/service/user/limits_by_id",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},data:"&userId="+o};return c(e).then(function(e){n.userLimits=angular.copy(e.data.object),t.resolve(o)},function(e){console.log("get user limit error"+e),t.reject()}),t.promise}function x(e){if(n.htmlexport){var o=window.htmlBookData;return void 0===o.showMode&&(o.showMode={type:"fit",width:document.body.clientWidth}),C(o),v(o),I(o),void R()}var t="CHART"===n.resourceType?charts_server+"/service/chartInstance/chartInstanceData/"+e:charts_server+"/service/charting/chartbookdata/"+e;c.get(t).success(function(e){var o=angular.copy(e.object),t="CHART"===n.resourceType?D:C;void 0===o.showMode&&(o.showMode={type:"fit",width:document.body.clientWidth}),t(o),v(o),I(o),R(),M("").then(function(){n.resourceLogoURL=n.useMobileLayout?"src/img/mob_logo_v2.png":3===n.themeId?"src/img/logo_play_white.png":"src/img/logo_play.png",n.userLimits.iscustomlogo?(n.showResourceLogo=n.resourceData.showChartBookLogo,!n.showResourceLogo&&"CHART"!==n.resourceType||function(e){var o=r.defer(),t={method:"POST",url:charts_server+"/service/charting/resource/book/getlogoimg",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},data:"chartbook_id="+e};c(t).then(function(e){e.data&&e.data.object?(n.resourceLogoURL=e.data.object,n.showResourceLogo=!0,n.customlogo=!0):n.showResourceLogo=!1,o.resolve()},function(e){console.log("resource logo error "+e),o.reject()}),o.promise}(o.id)):n.curRenderType===n.renderTypes.export?n.showResourceLogo=!n.userLimits.isnologo:n.showResourceLogo=!(n.userLimits.isnologoshare||n.userLimits.isnologoplay)},function(e){console.log("fetch user limit error"+e)})}).error(function(e){l.pop("error","","获取资源失败"),console.log(e)})}function D(e){document.title=e.name||"图表秀",n.resourceData=e,n.compatVersion=n.CHART_V2,n.widget=n.resourceData.widget,n.widget.resource.userData=JSON.parse(n.widget.resource.userData),n.themeId=n.resourceData.themeId,n.chartsUsed.push(n.widget.resource.compId)}function C(e){document.title=e.name||"图表秀",n.compatVersion=e.compatVersion,e.showMode||(e.showMode={type:"fit",width:document.body.clientWidth}),n.resourceData=e;var o=n.resourceData.pages;n.curRenderType===n.renderTypes.export?(o[n.chartBookWidgets=0].layout.widget[0].defineMobile||(n.supportMobileLayout=!1),n.useMobileLayout=n.supportMobileLayout&&(n.isMobile||(n.curRenderType===n.renderTypes.playOwn||n.curRenderType===n.renderTypes.export)&&n.resourceData.isMobileLayout),k(n.resourceData),A(n.resourceData),n.pagesHeight=[],n.exportStyle={width:0,height:0},_.each(o,function(e,o){void 0===n.sectionStyle[o]&&(n.sectionStyle[o]={}),_.each(e.layout.widget,function(o){switch(n.chartBookWidgets++,o.type){case"chart":n.compatVersion===g&&n.chartsUsed.push(o.resource.compId),o.resource.userData=JSON.parse(o.resource.userData),n.totalChartCount++;break;case"text":var t=/\d+/,e=o.resource.content.match(/(font-size):\d+/g);_.each(e,function(e){o.resource.content=o.resource.content.replace(e,"font-size:"+parseFloat(e.match(t)[0])*n.largeTextRatio)});break;case"icon":o.resource.iconFontSize=o.resource.iconFontSize*n.largeTextRatio}}),n.oldChartBook?(n.cnt_col=P(n.resourceData.layoutRatio)*n.columns,n.cnt_rows=S(e.layout.widget,n.cnt_col,n.useMobileLayout),n.max_rows=n.cnt_rows>n.max_rows?n.cnt_rows:n.max_rows,n.pagesHeight[o]=n.cnt_rows):(n.max_height=(n.useMobileLayout?e.mobilePageHeight:e.pageHeight)>n.max_height?n.useMobileLayout?e.mobilePageHeight:e.pageHeight:n.max_height,n.pagesHeight[o]=n.useMobileLayout?e.mobilePageHeight:e.pageHeight),e.options&&(e.options.backgroundImage||e.options.backgroundImageMobile)&&(void 0!==e.options.openBackgroundImage&&!e.options.openBackgroundImage||(n.sectionStyle[o]["background-image"]="url("+(n.useMobileLayout?e.options.backgroundImageMobile:e.options.backgroundImage)+")",n.sectionStyle[o]["background-size"]="100% 100%"))}),_.each(n.sectionStyle,function(e,o){n.useMobileLayout?"fit"===n.resourceData.showModeMobile.type?"fit"===n.resourceData.showModeMobile.pattern&&(e.width=document.body.clientWidth,n.isExportImg?(e.height=Math.ceil((n.oldChartBook?e.width/n.cnt_col*n.pagesHeight[o]:n.pagesHeight[o])*n.largeTextRatio),n.pagesHeight[o]=e.height):e.height=Math.ceil((n.oldChartBook?e.width/n.cnt_col*n.max_rows:n.max_height)*n.largeTextRatio)):"actual"===n.resourceData.showModeMobile.type&&(void 0===n.resourceData.showModeMobile.pattern&&(e.width=n.resourceData.showModeMobile.width,e.height=Math.ceil(e.width/n.cnt_col*n.max_rows)),"actual"===n.resourceData.showModeMobile.pattern&&(e.width=n.resourceData.showModeMobile.width,e.height=Math.ceil(n.resourceData.showModeMobile.height),e.margin="0 auto"),"scale"===n.resourceData.showModeMobile.pattern&&(e.width=n.resourceData.showModeMobile.width,e.height=Math.ceil(n.resourceData.showModeMobile.height),e.transformOrigin="0 0",e.transform="scale("+document.body.clientWidth/n.resourceData.showModeMobile.width+")")):"fit"===n.resourceData.showMode.type?("fit"===n.resourceData.showMode.pattern&&(e.width=document.body.clientWidth,n.isExportImg?e.height=Math.ceil((n.oldChartBook?e.width/n.cnt_col*n.pagesHeight[o]:n.pagesHeight[o])*n.largeTextRatio):e.height=Math.ceil((n.oldChartBook?e.width/n.cnt_col*n.max_rows:n.max_height)*n.largeTextRatio)),"fixRatio"===n.resourceData.showMode.pattern&&(e.width=document.body.clientWidth,e.height=e.width/16*9)):"actual"===n.resourceData.showMode.type?(void 0===n.resourceData.showMode.pattern&&(e.width=n.resourceData.showMode.width,e.height=Math.ceil(e.width/n.cnt_col*n.max_rows)),"actual"===n.resourceData.showMode.pattern&&(e.width=n.resourceData.showMode.width,e.height=Math.ceil(n.resourceData.showMode.height),e.margin="0 auto"),"scale"===n.resourceData.showMode.pattern&&(e.width=n.resourceData.showMode.width,e.height=Math.ceil(n.resourceData.showMode.height),e.transformOrigin="0 0",e.transform="scale("+document.body.clientWidth/n.resourceData.showMode.width+")")):"scale"===n.resourceData.showMode.type&&(e.width=n.resourceData.showMode.width,e.height=Math.ceil(e.width/n.cnt_col*n.cnt_rows),e.transformOrigin="0 0",e.transform="scale("+document.body.clientWidth/n.resourceData.showMode.width+")"),n.pagesHeight[o]=e.height,n.exportStyle.width=e.width,n.exportStyle.height+=e.height}),n.isExportImg||(n.exportStyle.height=n.exportStyle.height-o.length),n.compatVersion===s?chartsshow.message.subscribe("renderFinished",H):n.compatVersion===g&&n.$on("chartRenderDone",H),0===n.totalChartCount&&H(),n.themeId=n.resourceData.themeId):(o[0].layout.widget[0].defineMobile||(n.supportMobileLayout=!1),n.useMobileLayout=n.supportMobileLayout&&(n.isMobile||(n.curRenderType===n.renderTypes.playOwn||n.curRenderType===n.renderTypes.export)&&n.resourceData.isMobileLayout),n.pages=o,n.pageIndex>=n.pages.length&&(n.pageIndex=n.pages.length-1),n.themeId=n.resourceData.themeId,k(n.resourceData),A(n.resourceData),n.useMobileLayout?n.useMobileLayout&&n.isMobile?W(0):(n.dashboardPages=n.resourceData.pages,n.chartBookWidgets=0,_.each(n.resourceData.pages,function(e,o){_.each(e.layout.widget,function(o){switch(n.chartBookWidgets++,o.type){case"text":var t=/\d+/,e=o.resource.content.match(/(font-size):\d+/g);_.each(e,function(e){o.resource.content=o.resource.content.replace(e,"font-size:"+parseFloat(e.match(t)[0])*n.largeTextRatio)});break;case"icon":o.resource.iconFontSize=o.resource.iconFontSize*n.largeTextRatio;break;case"chart":o.resource.userData=JSON.parse(o.resource.userData)}}),L(n.resourceData,o)})):O(n.pageIndex))}function v(e){if(n.htmlexport)T(window.htmlTheme);else{var o=charts_server+"/service/charting/themedata/?bookId="+e.id;c.get(o).success(function(e){T(e.object)}).error(function(e){console.log("get resource theme error"+e)})}}function T(a){_.each(a,function(e,o){var t=a[o].id,r=_.findWhere(a,{id:t});i.addTheme(t,r.define),n.themeId===t&&(i.changeTheme(n.themeId),n.themeData=i.getCurrentTheme())}),n.themeData||(n.themeId="0",i.changeTheme(n.themeId),n.themeData=i.getCurrentTheme()),n.themeData.define.backgroundImage?n.mainStyle["background-image"]="url("+n.themeData.define.backgroundImage+")":n.mainStyle.background=function(e){var o;o=-1!==e.indexOf("radial-gradient")?(0<navigator.userAgent.indexOf("MSIE")&&(o=_browserDetect.ie<10?"#3A3E41":"-ms-"+n.themeData.define.background),Object.hasOwnProperty.call(window,"ActiveXObject")&&!window.ActiveXObject&&(o="-ms-"+n.themeData.define.background),0<navigator.userAgent.indexOf("Firefox")&&(o="-moz-"+n.themeData.define.background),0<navigator.userAgent.indexOf("Chrome")&&(o="-webkit-"+n.themeData.define.background),0<navigator.userAgent.indexOf("Opera")&&(o="-o-"+n.themeData.define.background),o||"-webkit-"+n.themeData.define.background):n.themeData.define.background;return o}(n.themeData.define.background),n.$broadcast("init-theme-done")}function R(){a.loadEngine(n.compatVersion,!n.htmlexport,n.chartsUsed).then(function(){console.log("load chart engine success")},function(e){console.log("load chart engine error"+e)})}function k(e){n.useMobileLayout?e.showModeMobile&&"fit"===e.showModeMobile.type&&(n.largeTextRatio=(414<document.body.clientWidth?414:document.body.clientWidth)/parseFloat(e.pages[n.pageIndex].mobilePageWidth)):"fit"===e.showMode.type&&("fit"!==e.showMode.pattern&&"fixRatio"!==e.showMode.pattern||(n.largeTextRatio=document.body.clientWidth/parseFloat(e.pages[n.pageIndex].pageWidth)))}function L(e,o){void 0===n.sectionStyle[o]&&(n.sectionStyle[o]={});var t=n.sectionStyle[o];if(t.position=n.useMobileLayout?"relative":"absolute",n.useMobileLayout)if(e.showModeMobile)"fit"===e.showModeMobile.type?("fit"===e.showModeMobile.pattern&&(t.height=e.pages[o].mobilePageHeight*n.largeTextRatio,t.height=t.height>screen.height?t.height:screen.height,t.width=n.isMobile?document.body.clientWidth:e.pages[o].mobilePageWidth),t.margin="0 auto"):"actual"===e.showModeMobile.type&&("actual"===e.showModeMobile.pattern?(t.width=e.showModeMobile.width,t.height=e.showModeMobile.height,t.height=t.height>screen.height?t.height:screen.height,t.left="50%",t.marginLeft=-t.width/2):"scale"===e.showModeMobile.pattern&&(t.width=e.showModeMobile.width,t.height=e.showModeMobile.height,t.height=t.height>screen.height?t.height:screen.height,t.transformOrigin="0 0",t.transform="scale("+document.body.clientWidth/e.showModeMobile.width+")"));else{t.width=414;var r=P(e.layoutRatio)*n.columns,a=S(e.pages[o].layout.widget,r,!0);t.height=t.width/r*a+60,t.margin="0 auto"}else"fit"===e.showMode.type?("fit"===e.showMode.pattern?t.height=e.pages[o].pageHeight*n.largeTextRatio:"fixRatio"===e.showMode.pattern&&(t.height=9*document.body.clientWidth/16),t.width=document.body.clientWidth):"actual"===e.showMode.type?(void 0===e.showMode.pattern&&(t.width=e.showMode.width),"actual"===e.showMode.pattern&&(t.width=e.showMode.width,t.height=e.showMode.height,t.left="50%",t.marginLeft=-t.width/2),"scale"===e.showMode.pattern&&(t.width=e.showMode.width,t.height=e.showMode.height,t.transformOrigin="0 0",t.transform="scale("+document.body.clientWidth/e.showMode.width+")")):"scale"===e.showMode.type&&(t.width=document.body.clientWidth,t.transformOrigin="0 0",t.transform="scale("+document.body.clientWidth/e.showMode.width+")");e.pages[o].options&&(e.pages[o].options.backgroundImage||e.pages[o].options.backgroundImageMobile)&&(void 0!==e.pages[o].options.openBackgroundImage&&!e.pages[o].options.openBackgroundImage||(t["background-image"]="url("+(n.useMobileLayout?e.pages[o].options.backgroundImageMobile:e.pages[o].options.backgroundImage)+")",t["background-size"]="100% 100%"))}function I(e){e.playChartBookMusic&&e.musicMediaSaved&&e.musicMediaSaved.musicMediaSelect&&e.musicMediaSaved.musicMediaSelect.musicPath&&(n.musicControlModel=o.load(e.musicMediaSaved.musicMediaSelect.musicPath),n.musicControlModel.setVolume(.8),n.musicControlModel.loop=100,n.musicControlModel.status="paused",n.showMusicIcon=!0,0<=e.musicMediaSaved.autoPlayList.indexOf(e.musicMediaSaved.musicMediaSelect.musicId.toString())&&(n.musicControlModel.play(),n.musicControlModel.status="playing"))}function S(e,o,t){for(var r=[],a=0;a<o;a++)r[a]=0;var i=0;for(a=0;a<e.length;a++){var s=t?e[a].defineMobile.sizeX:e[a].define.sizeX,n=t?e[a].defineMobile.sizeY:e[a].define.sizeY;o<i+s&&(i=0);for(var c=0;c<s&&i<o;c++)r[c+i]+=n;i+=s}return Math.max.apply(null,r)}function O(e){n.renderedWidgetCount=0,n.loadedPages[e]||(n.loadedPages[e]=n.pages[e],n.dashboardPages=_.compact(n.loadedPages),_.each(n.resourceData.pages[e].layout.widget,function(o){switch(o.type){case"text":var t=/\d+/,e=o.resource.content.match(/(font-size):\d+/g);_.each(e,function(e){o.resource.content=o.resource.content.replace(e,"font-size:"+parseFloat(e.match(t)[0])*n.largeTextRatio)});break;case"icon":o.resource.iconFontSize=o.resource.iconFontSize*n.largeTextRatio;break;case"chart":o.resource.userData=JSON.parse(o.resource.userData)}}),L(n.resourceData,e)),n.$broadcast("drawChart")}function W(e){n.totalMobileWidgetCount=0,O(e),n.totalMobileWidgetCount=n.pages[e].layout.widget.length}function P(e){return null==e||e<1?1:e}function H(){n.renderedChartCount++,n.renderedChartCount!==n.totalChartCount&&0!==n.totalChartCount||t(function(){window.status="ready",window.export={},window.export.height=n.sectionStyle[0].height,window.export.width=n.sectionStyle[0].width,window.export.pagesHeight=angular.copy(n.pagesHeight),console.log(window.status)})}function A(e){for(var o=e.pages,t=0;t<o.length;t++){for(var r=e.pages[t].layout.widget,a=0;a<r.length;a++)if(n.useMobileLayout){if(void 0===r[a].defineMobile.zIndex){n.oldChartBook=!0;break}}else if(void 0===r[a].define.zIndex){n.oldChartBook=!0;break}n.oldChartBook&&e.options&&(e.options.openBackgroundImage=!0)}n.oldChartBook&&(n.resourceData.playChartBookMusic=!0,n.resourceData.showChartBookLogo=!0,n.resourceData.playChartBookMusic=!0)}function B(){var e=document.querySelector(".loading");if(e&&(e.style.display="none"),n.isMobile){var o=document.querySelector("footer .pulling-up");o&&(o.style.animationPlayState="running",o.addEventListener("animationend",function(){t(function(){n.showMobileAd=n.isMobile&&!n.userLimits.isnologo&&n.showResourceLogo,n.closeMobileAd=function(){n.showMobileAd=!1}})}))}}location.search.replace(/([^?&=]+)=([^&]+)/g,function(e,o,t){b[o]=t}),location.href.replace(/\/p\/s\/([a-zA-Z0-9]+)/,function(e,o){b.s=o}),n.CHART_V1=s,n.CHART_V2=g,n.htmlexport=!0===window.htmlexport,n.isMobile=navigator.userAgent.match(/AppleWebKit.*Mobile.*/),n.resourceType=b.hasOwnProperty("isChart")?"CHART":"CHARTBOOK",n.isFromOffice=b.hasOwnProperty("from_office"),n.isLoadAll=b.hasOwnProperty("load_all"),n.isExportImg=b.hasOwnProperty("print-img"),n.pageIndex=location.hash.split("/")[1]?parseInt(location.hash.split("/")[1]):0,n.mainStyle={},n.sectionStyle=[],n.chartsUsed=[],n.loadedPages=[],n.dashboardPages=[],n.pages=[],n.renderTypes={playOwn:0,playShare:1,export:2},n.supportMobileLayout=!0,n.useMobileLayout=!1,n.showResourceLogo=!1,n.showMusicIcon=!1,n.musicControlModel=null,n.largeTextRatio=1,n.columns=12,n.totalChartCount=0,n.renderedChartCount=0,n.renderedWidgetCount=0,n.isRenderFinished=!1,b.hasOwnProperty("c")||n.htmlexport?n.curRenderType=n.renderTypes.playOwn:b.hasOwnProperty("s")?n.curRenderType=n.renderTypes.playShare:(b.hasOwnProperty("print-pdf")||b.hasOwnProperty("print-img"))&&(n.curRenderType=n.renderTypes.export),n.curRenderType===n.renderTypes.export&&(n.max_height=-1,n.max_rows=-1),n.userLogin=function(o){var t=d.open({templateUrl:"src/tpl/charting/shareLogin.html",size:"lg",backdrop:"static",controller:["$scope","$modalInstance","$sce",function(e,o,t){cas_server?e.loginPageUrl=t.trustAsResourceUrl(cas_server+cas_default_service):e.loginPageUrl=t.trustAsResourceUrl("src/index.html#/access/signin/0"),e.dismiss=function(){o.dismiss()}}]});window.onmessage=function(e){"LOGIN_SUCCESS"===e.data&&(window.onmessage=null,t.dismiss(),o&&o())}},n.pageTurn=function(e){"prev"===e?n.pageIndex&&(n.$broadcast("scroll-to-top"),n.pageIndex=n.pageIndex-1,O(n.pageIndex)):"next"===e&&n.pageIndex<n.pages.length-1&&(n.$broadcast("scroll-to-top"),n.pageIndex=n.pageIndex+1,O(n.pageIndex))},n.toggleMusicPlay=function(e){"playing"===n.musicControlModel.status?(n.musicControlModel.pause(),n.musicControlModel.status="paused"):"paused"===n.musicControlModel.status&&(n.musicControlModel.play(),n.musicControlModel.status="playing"),e.stopPropagation()},n.$on("set-page-info",function(){n.pageIndex<n.pages.length-1&&(W(n.pageIndex+1),n.$broadcast("set-page-info-done"))}),n.$on("render-widget-done",function(){"CHARTBOOK"===n.resourceType?(n.renderedWidgetCount++,n.curRenderType===n.renderTypes.export?n.renderedWidgetCount===n.chartBookWidgets&&n.themeDataReady&&n.$broadcast("render-play-widget"):n.useMobileLayout?n.useMobileLayout&&n.isMobile?n.renderedWidgetCount===n.totalMobileWidgetCount&&n.themeDataReady&&n.$broadcast("render-play-widget"):n.renderedWidgetCount===n.chartBookWidgets&&n.themeDataReady&&n.$broadcast("render-play-widget"):n.renderedWidgetCount===n.resourceData.pages[n.pageIndex].layout.widget.length&&n.themeDataReady&&n.$broadcast("render-play-widget")):n.themeDataReady&&n.$broadcast("render-play-widget"),B()}),n.$on("init-theme-done",function(){"CHARTBOOK"===n.resourceType?(n.themeDataReady=!0,n.curRenderType===n.renderTypes.export?n.renderedWidgetCount===n.chartBookWidgets&&n.themeDataReady&&n.$broadcast("render-play-widget"):n.useMobileLayout?n.useMobileLayout&&n.isMobile?n.renderedWidgetCount===n.totalMobileWidgetCount&&n.themeDataReady&&n.$broadcast("render-play-widget"):n.renderedWidgetCount===n.chartBookWidgets&&n.themeDataReady&&n.$broadcast("render-play-widget"):n.renderedWidgetCount===n.resourceData.pages[n.pageIndex].layout.widget.length&&n.themeDataReady&&n.$broadcast("render-play-widget")):(n.themeDataReady=!0,n.$broadcast("render-play-widget")),B()}),n.$on("interaction-trigger-emit",function(e,o){e.stopPropagation&&e.stopPropagation(),n.$broadcast("interaction-trigger-broadcast",o)}),n.$on("interaction-recover-emit",function(e,o){e.stopPropagation&&e.stopPropagation(),n.$broadcast("interaction-recover-broadcast",o)}),$(window).on("resize",function(){k(n.resourceData),n.useMobileLayout||L(n.resourceData,n.pageIndex),n.$broadcast("init-widget-style")}),document.addEventListener("keydown",function(e){switch(e.stopPropagation(),e.keyCode){case 33:case 37:n.pageTurn("prev");break;case 34:case 39:n.pageTurn("next")}},!0),n.curRenderType===n.renderTypes.playOwn?x(b.c):n.curRenderType===n.renderTypes.playShare?(m=b.s,w=n.isFromOffice?"true":"false",y=charts_server+"/service/resource/sharing/resource?code="+m+"&fromOffice="+w,f=function(e){l.pop("error","","获取分享资源失败"),console.log("fetch shared resource data failed"+e)},c.get(y).success(function t(e){if(e.error)switch(e.error.c){case"SEC-214":l.pop("info","","访问密码错误，请重新输入");case"SEC-213":d.open({templateUrl:"src/tpl/charting/sharePass.html",size:"sm",backdrop:"static",controller:["$scope","$modalInstance",function(e,o){e.submit=function(){o.close(e.pass)}}]}).result.then(function(e){var o=y+"&pass="+e;c.get(o).success(t).error(f)});break;case"SEC-216":n.userLogin(function(){c.get(y).success(s_handler).error(f_handler)});break;default:l.pop("error","",e.error.m)}else{var o=e.object,r=e.object.LogoPath,a="CHART"===n.resourceType?o.resource.coverImageStore:o.resource.isMyCoverImage?o.resource.ownIconStore:o.resource.iconStore,i="CHART"===n.resourceType?o.resource.description:o.resource.desc,s="图表秀-拯救一切图表不开心";!function(e,o,t){var r={title:e,link:location.href.split("#")[0],imgUrl:t,success:function(){},cancel:function(){}},a={title:e,desc:o,link:location.href.split("#")[0],imgUrl:t,type:"",dataUrl:"",success:function(){},cancel:function(){}};p.config(location.href,r,a)}(o.resource.name,s=i||s,"http"==a.substring(0,4)?a:charts_server+"/service/charting/resource/image?path="+a),("CHART"===n.resourceType?D:C)(o.resource),I(o.resource),"CHARTBOOK"===n.resourceType&&(function(){var c=d3.map(),d=d3.map();_.each(n.pages,function(e,o){var t=e.interaction;_.each(e.layout.widget,function(e){"chart"===e.type&&(c.set(e.resource.id,e.resource.userData),d.set(e.resource.id,e.resource.dataCrosstab))}),t&&_.each(t,function(n,e){var o=n.from+"_click";"undefined"!=typeof chartsshow&&chartsshow.message.subscribe(o,function(e){var o=e[n.mapping.fromField],t=c.get(n.to),r=d.get(n.to),a=u.array2json(t,r),i={};i[n.mapping.toField]=o;var s=_.where(a,i);h.$broadcast("interactiveChart",{id:n.to,data:s})})})})}(),M(n.resourceData.ownerId).then(function(){n.resourceLogoURL=n.useMobileLayout?"src/img/mob_logo_v2.png":3===n.themeId?"src/img/logo_play_white.png":"src/img/logo_play.png",n.userLimits.iscustomlogo?(n.showResourceLogo=n.resourceData.showChartBookLogo,n.showResourceLogo&&(n.resourceLogoURL=r,n.customlogo=!0),n.resourceLogoURL||(n.showResourceLogo=!1)):n.curRenderType===n.renderTypes.export?n.showResourceLogo=!n.userLimits.isnologo:n.showResourceLogo=!(n.userLimits.isnologoshare||n.userLimits.isnologoplay)},function(e){console.log("fetch user limit error"+e)})),o.theme&&(n.themeId=o.theme.id,T([o.theme]))}}).error(f)):n.curRenderType===n.renderTypes.export&&x(n.isExportImg?b["print-img"]:b["print-pdf"])}]);