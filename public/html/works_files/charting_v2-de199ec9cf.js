/*!***********************************************
 Copyright (c) 2019, Neusoft Inc.
 All rights reserved
 图表秀 Version 1.0.0 2020.4.24
 ************************************************/
"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}charting.service("chartService",["$http","$q","$timeout","userDataService",function(m,g,e,i){var p={chartbookId:"",dataSetBindings:[]},r={};return{dispose:function(e){if(e.simpleJson.dom&&""!==e.simpleJson.dom){var t=function(e){if(e.data){var t={};return t.dom=e.dom,t.themeName=e.themeName,t.data=angular.copy(e.data),t.option=angular.copy(e.option),ChartParse.getChartsInstance(t)}}(e.simpleJson);if(t.instance)for(var r in t.dispose(),e.simpleJson.data.properties)e.simpleJson.data.properties[r].bind=[]}},getBindData:function(e,t,r,i){var a={method:"post",url:datavizOption.chartedit.rest.chartData,headers:{"X-Date":(new Date).toUTCString()},data:{datasetId:e,bindFields:t,conditions:r,dataSetBindings:i}},n=g.defer();datavizOption.chartedit.chartData.getChartDataByRest?m(a).then(function(e){e.data.error?n.reject(e.data.error):n.resolve(e.data.object)},function(e){console.error(e)}):datavizOption.chartedit.chartData.getBindData?n.resolve(datavizOption.chartedit.chartData.getBindData()):n.reject("chartData.getBindData is undefined !");return n.promise},getDrillThroughData:function(e,t){var r={method:"post",url:datavizOption.chartedit.rest.drillThrough,headers:{"X-Date":(new Date).toUTCString()},data:{datasetId:e,conditions:t}},i=g.defer();datavizOption.chartedit.chartData.getChartDrillDataByRest?m(r).then(function(e){e.data.error?i.reject(e.data.error):i.resolve(e.data.object)},function(e){console.error(e)}):datavizOption.chartedit.chartData.getDrillData?i.resolve(datavizOption.chartedit.chartData.getDrillData()):i.reject("chartData.getDrillData is undefined !");return i.promise},registerDataSetBindings:function(e,t){var r={},i=[];p.chartbookId=e;for(var a=0,n=t.length;a<n;a++){var o=t[a].l.dataset+t[a].r.dataset,s=t[a].r.dataset+t[a].l.dataset;if(r[o]||r[s])r[o]?r[o].fields.push({field1:t[a].l.field,field2:t[a].r.field}):r[s]&&r[s].fields.push({field1:t[a].r.field,field2:t[a].l.field});else{var d={};d.ds1=t[a].l.dataset,d.ds2=t[a].r.dataset,d.fields=[],d.fields.push({field1:t[a].l.field,field2:t[a].r.field}),r[o]=d,i.push(d)}}p.dataSetBindings=i},checkDataSetBindings:function(e){var t,r=[],i=[];r.push(e),(t=a(r))&&(r.push(t.dsId),i.push(t.bindings));for(;t&&!t.over;)(t=a(r))&&(r.push(t.dsId),i.push(t.bindings));return i},getInteractiveStatus:function(e){return r[e]},setInteractiveStatus:function(e,t){r[e]=t},cancelInteractiveStatus:function(e){delete r[e]},metaJsonToSimpleJson:function(e){return function e(t){var r={};for(var i in t)if(t[i].type&&"Array"===t[i].type[0])if(r[i]=[],t[i].items&&t[i].items.anyOf){var a=e(t[i].items.anyOf);for(var n in a)a[n][0]?r[i].push(a[n][0]):r[i].push(a[n])}else if(t[i].items)r[i].push(e(t[i].items.properties));else if(t[i].properties)r[i].push(e(t[i].properties));else{var o=t[i].default;if(o)for(var s in o)r[i].push(o[s])}else if(t[i].properties)r[i]=e(t[i].properties);else if(t[i].type&&"segmentLine"===t[i].type[0]){var d={items:{}};d.items.start=t[i].items.start.default,t[i].items.color?d.items.color=t[i].items.color.default:d.items.end=t[i].items.end.default,r[i]=d}else r[i]=t[i].default;return r}(e)},simpleJsonToMetaJson:function(e,t){return function i(t,a){var n={};for(var o in t)if(a.properties[o])if(_.isArray(t[o])&&0!==t[o].length)"series"===o||"seriesLeft"===o||"seriesRight"===o||"dataZoom"===o||"visualMap"===o||"grid"===o||"data"===o?(n[o]={},n[o].name=a.properties[o].name,n[o].type=a.properties[o].type,n[o].isShow=a.properties[o].isShow,void 0!==a.properties[o].max&&(n[o].max=a.properties[o].max),void 0!==a.properties[o].min&&(n[o].min=a.properties[o].min),n[o].items={},n[o].items.anyOf=[],_.each(t[o],function(e,t){var r={};r.name=a.properties[o].name,r.type=a.properties[o].type,r.isShow=a.properties[o].isShow,void 0!==a.properties[o].max&&(n[o].max=a.properties[o].max),void 0!==a.properties[o].min&&(n[o].min=a.properties[o].min),a.properties[o].items.anyOf&&(r.properties=i(e,a.properties[o].items.anyOf[t])),n[o].items.anyOf.push(r)})):"xAxis"===o||"yAxis"===o||"parallelAxis"===o?(n[o]={},n[o].name=a.properties[o].name,n[o].type=a.properties[o].type,n[o].isShow=a.properties[o].isShow,void 0!==a.properties[o].max&&(n[o].max=a.properties[o].max),void 0!==a.properties[o].min&&(n[o].min=a.properties[o].min),_.each(t[o],function(e,t){if(a.properties[o].items&&a.properties[o].items.anyOf){n[o].items&&n[o].items.anyOf||(n[o].items={},n[o].items.anyOf=[]);var r={};r.name=a.properties[o].name,r.type=a.properties[o].type,r.isShow=a.properties[o].isShow,void 0!==a.properties[o].max&&(n[o].max=a.properties[o].max),void 0!==a.properties[o].min&&(n[o].min=a.properties[o].min),r.properties=i(e,a.properties[o].items.anyOf[t]),n[o].items.anyOf.push(r)}else a.properties[o].properties&&(n[o].properties=i(e,a.properties[o]))})):"radius"===o?(n[o]={},n[o].name=a.properties[o].name,n[o].type=a.properties[o].type,n[o].isShow=a.properties[o].isShow,void 0!==a.properties[o].max&&(n[o].max=a.properties[o].max),void 0!==a.properties[o].min&&(n[o].min=a.properties[o].min),n[o].default=t[o]):"symbolSize"===o?(n[o]={},n[o].name=a.properties[o].name,n[o].type=a.properties[o].type,n[o].isShow=a.properties[o].isShow,void 0!==a.properties[o].max&&(n[o].max=a.properties[o].max),void 0!==a.properties[o].min&&(n[o].min=a.properties[o].min),n[o].default=t[o]):"color"===o||"colorSaturation"===o?(n[o]={},n[o].name=a.properties[o].name,n[o].type=a.properties[o].type,n[o].isShow=a.properties[o].isShow,void 0!==a.properties[o].max&&(n[o].max=a.properties[o].max),void 0!==a.properties[o].min&&(n[o].min=a.properties[o].min),n[o].default=t[o]):"singleAxis"===o&&(n[o]={},n[o].name=a.properties[o].name,n[o].type=a.properties[o].type,n[o].isShow=a.properties[o].isShow,void 0!==a.properties[o].max&&(n[o].max=a.properties[o].max),void 0!==a.properties[o].min&&(n[o].min=a.properties[o].min),n[o].properties={},_.each(t[o],function(e,t){var r={};r=i(e,a.properties[o]),n[o].properties=r}));else if(_.isObject(t[o])){var r,s;if(n[o]={},a.properties[o]&&"segmentsArray"===o)!function(){var e=function e(t){var r={};for(var i in t)r[i]="object"===_typeof(t[i])?e(t[i]):t[i];return r};for(r in n[o].name=a.properties[o].name,n[o].type=a.properties[o].type,n[o].isShow=a.properties[o].isShow,void 0!==a.properties[o].max&&(n[o].max=a.properties[o].max),void 0!==a.properties[o].min&&(n[o].min=a.properties[o].min),n[o].properties={},t[o])(s=e(a.properties[o].properties[1e3])).name="第"+(1*r+1)%1e3+"段",s.items.start.default=t[o][r].items.start,t[o][r].items.color?s.items.color.default=t[o][r].items.color:s.items.end.default=t[o][r].items.end,n[o].properties[r]=s}();else a.properties[o]&&(n[o].name=a.properties[o].name,n[o].type=a.properties[o].type,n[o].isShow=a.properties[o].isShow,void 0!==a.properties[o].max&&(n[o].max=a.properties[o].max),void 0!==a.properties[o].min&&(n[o].min=a.properties[o].min),n[o].properties=i(t[o],a.properties[o]))}else n[o]={},a.properties[o]&&(n[o].name=a.properties[o].name,a.properties[o].items&&(n[o].items=a.properties[o].items),n[o].type=a.properties[o].type,n[o].isShow=a.properties[o].isShow,void 0!==a.properties[o].max&&(n[o].max=a.properties[o].max),void 0!==a.properties[o].min&&(n[o].min=a.properties[o].min),n[o].default=t[o]);return n}(e,t)},defaultUserDataBind:function(e){var t=e.simpleJson,r=t.data.default,i=e.compId;if(!r||!t.data.properties)return void console.warn("userData or dataProperties is error");for(var a=angular.copy(r[0]),n=[],o=0;o<a.length;o++)a[o]&&n.push(a[o].replace(new RegExp("（","gm"),"(").replace(new RegExp("）","gm"),")"));var s=t.data.properties;function d(e){for(var t=[],r=0;r<e.length;r++)"[空]"!==n[e[r]]&&e[r]<n.length&&t.push({name:n[e[r]],fieldName:n[e[r]],nameIndex:e[r],fieldSetting:{},areaFlag:!1});return t}switch(i){case"58":s.xAxis.bind=d([0]),s.value.bind=d(_.range(1,r[0].length));break;case"8":s.xAxis.bind=d([0]),s.yAxis.bind=d([1]),s.value.bind=d(_.range(2,r[0].length));break;case"0":s.yAxis.bind=d([0]),3<=r[0].length?(s.legend.bind=d([1]),s.value.bind=d(_.range(2,r[0].length))):(s.legend.bind=[],s.value.bind=d([1]));break;case"1":case"111":s.yAxis.bind=d([0]),s.value.bind=d(_.range(1,r[0].length));break;case"2":case"984":s.yAxis.bind=d([0]),3<=r[0].length?(s.legend.bind=d([1]),s.value.bind=d(_.range(2,r[0].length))):(s.legend.bind=[],s.value.bind=d([1]));break;case"3":case"4":case"983":s.xAxis.bind=d([0]),3<=r[0].length?(s.legend.bind=d([1]),s.value.bind=d(_.range(2,r[0].length))):(s.legend.bind=[],s.value.bind=d([1]));break;case"22":case"23":s.xAxis.bind=d([0]),3<=r[0].length?(s.legend.bind=d([1]),s.value.bind=d(_.range(2,r[0].length))):(s.legend.bind=[],s.value.bind=d([1]));break;case"25":s.xAxis.bind=d([0]),s.value.bind=d(_.range(1,r[0].length,2)),s.valueBar.bind=d(_.range(2,r[0].length,2));break;case"1025":s.xAxis.bind=d([0]),s.valueLeft.bind=d(_.range(1,r[0].length,2)),s.valueRight.bind=d(_.range(2,r[0].length,2));break;case"999":s.xAxis.bind=d([0]),s.value.bind=d(_.range(1,r[0].length,2)),s.valueBar.bind=d(_.range(2,r[0].length,2));break;case"34":s.category_src.bind=d([0]),s.category_tar.bind=d([1]),s.source.bind=d([0]),s.target.bind=d([1]),s.value.bind=d([2]);break;case"49":s.legend.bind=d(_.range(0,r[0].length-1)),s.value.bind=d([r[0].length-1]);break;case"6":case"47":s.source.bind=d([0]),s.target.bind=d([1]),s.value.bind=d([2]);break;case"51":s.legend.bind=d([0]),s.value.bind=d([1]);break;case"64":s.ID.bind=d([0]),s.node.bind=d([1]),s.value.bind=d([2]),s.parentID.bind=d([3]);break;case"66":s.source.bind=d([0]),s.nodeName.bind=d([1]),s.category.bind=d([2]),s.value.bind=d([3]),s.target.bind=d([4]);break;case"48":s.xAxis.bind=d([0]),s.legend.bind=d([1]),s.value.bind=d([2]);break;case"27":s.xAxis.bind=d([0]),s.status.bind=d([1]),s.value.bind=d(_.range(2,r[0].length));break;case"28":s.yAxis.bind=d([0]),s.status.bind=d([1]),s.value.bind=d(_.range(2,r[0].length));break;case"40":s.parallelAxis.bind=d([0]),s.value.bind=d(_.range(1,r[0].length));break;case"30":s.xAxis.bind=d([0]),s.open.bind=d([1]),s.close.bind=d([2]),s.lowest.bind=d([3]),s.highest.bind=d([4]);break;case"32":s.line1.bind=d([0]),s.line2.bind=d([1]),s.value1.bind=d([2]),s.value2.bind=d([3]);break;case"50":s.text.bind=d([0]),s.value.bind=d([1]);break;case"60":s.text.bind=d([0]),s.value.bind=d([1]),0!=d([2]).length&&(s.valueLabel.bind=d([2]));break;case"982":s.text.bind=d([0]),s.value.bind=d([1]);break;case"83":case"831":if(r){if(s.yAxis.bind=new Array(0),s.currentValue.bind=new Array(0),s.intentValue.bind=new Array(0),0!=d([0]).length&&(s.yAxis.bind=d([0])),0!=d([1]).length){for(p=0;p<r.length;p++)r[p][1]=""==r[p][1]?1:r[p][1];s.intentValue.bind=d([1])}if(0!=d([2]).length){for(p=0;p<r.length;p++)r[p][2]=""==r[p][2]?1:r[p][2];s.currentValue.bind=d([2])}}break;case"88":s.xAxis.bind=d([0]),s.value.bind=d(_.range(1,r[0].length));break;case"1077":s.leftValue.bind=[],s.value.bind=[],s.rightValue.bind=[];for(var p=0;p<r[0].length&&!(3<=p);p++)if(r[0][p]&&r[1][p]){if(0==s.value.bind.length){s.value.bind=d([p]);continue}if(0==s.leftValue.bind.length){s.leftValue.bind=d([p]);continue}if(0==s.rightValue.bind.length){s.rightValue.bind=d([p]);break}}break;case"35":s.value.bind=d([0]);break;case"63":s.value.bind=d([1]);break;case"68":s.value.bind=d([0]);break;case"11":case"10":case"13":case"14":case"15":case"16":s.xAxis.bind=d([0]),3<=r[0].length?(s.legend.bind=d([1]),s.value.bind=d(_.range(2,r[0].length))):(s.legend.bind=[],s.value.bind=d([1]));break;case"12":s.yAxis.bind=d([0]),3<=r[0].length?(s.legend.bind=d([1]),s.value.bind=d(_.range(2,r[0].length))):(s.legend.bind=[],s.value.bind=d([1]));break;case"17":s.xAxis.bind=d([0]),s.value.bind=d(_.range(1,r[0].length));break;case"42":case"41":case"411":case"7":s.legend.bind=d([0]),s.value.bind=d([1]);break;case"46":s.legend.bind=d([0]),s.outerSize.bind=d([1]),s.innerSize.bind=d([2]);break;case"70":s.value.bind=d([1]);break;case"31":s.xAxis.bind=d([0]),s.yAxis.bind=d([1]),s.value.bind=d([2]);break;case"52":case"998":s.legend.bind=d([0]),s.yAxis.bind=d([1]),s.xAxis.bind=d([2]),s.size.bind=d([3]);break;case"53":s.xAxis.bind=d([0]),s.yAxis.bind=d([1]),s.size.bind=d([2]);break;case"54":case"55":case"993":s.geo.bind=d([0]),s.size.bind=d([1]);break;case"56":s.legend.bind=d([0]),s.geo.bind=d([1]),s.size.bind=d([2]);break;case"57":s.angleAxis.bind=d([0]),s.radiusAxis.bind=d([1]),s.size.bind=d([2]);break;case"39":s.geo.bind=d([0]),s.value.bind=d(_.range(1,r[0].length));break;case"992":s.geo.bind=d([0]),s.value.bind=d([1]),0<d([2]).length&&(s.labelStyle.bind=d([2]));break;case"38":s.source.bind=d([0]),s.target.bind=d([1]),s.value.bind=d([2]);break;case"61":s.longitude.bind=d([0]),s.latitude.bind=d([1]),s.sample.bind=d([2]);break;case"62":s.longitude.bind=d([0]),s.latitude.bind=d([1]),s.count.bind=d([2]);break;case"67":s.longitude.bind=d([0]),s.latitude.bind=d([1]),s.sample.bind=d([2]),s.details.bind=d([3]);break;case"36":s.xAxis.bind=d([0]),s.yAxis.bind=d([1]),s.value.bind=d([2]);break;case"37":s.geo.bind=d([0]),s.value.bind=d([1]);break;case"59":s.col.bind=d([0]),s.row.bind=d([1]),s.value.bind=d([2]);break;case"45":s.legend.bind=d([0]),s.value.bind=d(_.range(1,r[0].length));break;case"44":s.group.bind=d([0]),s.text.bind=d([1]),s.value.bind=d([2]);break;case"33":s.legend.bind=d([0]),s.value.bind=d([1]);break;case"65":s.legend.bind=d([1]),s.timeField.bind=d([0]),s.value.bind=d([2]);break;case"71":case"72":s.longitude.bind=d([1]),s.latitude.bind=d([2]),s.value.bind=d([3]);break;case"73":s.xAxis3D.bind=d([0]),s.yAxis3D.bind=d([1]),s.value.bind=d([2]);break;case"76":case"77":s.xAxis.bind=d([0]),s.legend.bind=d([1]),s.value.bind=d([2]);break;case"78":s.kind.bind=d([0]),s.value.bind=d([1]);break;case"81":s.angleAxis.bind=d([0]),s.radiusAxis.bind=d([1]);break;case"997":case"996":s.xAxis.bind=d([0]),s.legend.bind=d([1]),s.value.bind=d([2]),s.time.bind=d([3]);break;case"995":s.legend.bind=d([0]),s.yAxis.bind=d([1]),s.xAxis.bind=d([2]),s.size.bind=d([3]),s.time.bind=d([4]);break;case"994":s.value.bind=d([0]),s.time.bind=d([1]);break;case"2076":s.map.bind=d([0]),s.value.bind=d([1]),s.geo.bind=d([2]),s.size.bind=d([3]),0<d([4]).length&&(s.labelStyle.bind=d([4]));break;case"991":s.node.bind=d([0]),s.value.bind=d([1]),s.parentID.bind=d([2]);break;case"990":s.xAxis.bind=d([0]),s.value.bind=d(_.range(1,r[0].length));break;case"985":s.yAxis.bind=d([0]),s.value.bind=d(_.range(1,r[0].length));break;case"989":s.yAxis.bind=d([0]),3<=r[0].length?(s.legend.bind=d([1]),s.value.bind=d(_.range(2,r[0].length))):(s.legend.bind=[],s.value.bind=d([1]));break;case"986":s.xAxis.bind=d([0]),3<=r[0].length?(s.legend.bind=d([1]),s.value.bind=d(_.range(2,r[0].length))):(s.legend.bind=[],s.value.bind=d([1]));break;case"988":s.yAxis.bind=d([0]),s.value.bind=d(_.range(1,r[0].length-1)),s.time.bind=d([r[0].length-1]);break;case"987":s.xAxis.bind=d([0]),s.legend.bind=d([1]),s.stack.bind=d([2]),s.value.bind=d([3]);break;case"1078":s.legend.bind=d(_.range(0,r[0].length-1)),s.value.bind=d([r[0].length-1]);break;case"1079":s.legend.bind=d([0]),s.value.bind=d([1]);break;case"1080":s.legend.bind=d(_.range(0,r[0].length-1)),s.value.bind=d([r[0].length-1]);break;case"832":s.yAxis.bind=d([0]),s.legend.bind=d([1]),s.value.bind=d([2]),s.time.bind=d([3])}},specialProcessChart:function(e,t){var n=e.simpleJson,o=n.data.default,r=e.compId;if(!o||!n.data.properties)return void console.warn("userData or dataProperties is error");for(var i=angular.copy(o[0]),s=[],a=0;a<i.length;a++)i[a]&&s.push(i[a].replace(new RegExp("（","gm"),"(").replace(new RegExp("）","gm"),")"));if(t)for(var d in n.data.properties){if(n.data.properties.hasOwnProperty(d))if((l=n.data.properties[d]).bind)for(a=0;a<l.bind.length;a++)l.bind[a].hasOwnProperty("nameIndex")?(l.bind[a].name=s[l.bind[a].nameIndex],l.bind[a].fieldName=s[l.bind[a].nameIndex]):l.bind[a].nameIndex=s.indexOf(l.bind[a].name)}if(n.option.properties.visualMap){var p=n.option.properties.visualMap;void 0===p.items.anyOf[0].properties.inRange&&(p.items.anyOf[0].properties.inRange={name:"选中元素",isShow:!1,type:["Object"],properties:{color:{name:"颜色",isShow:!1,type:["Array"],default:["#00471D","#026931","#228D47"]}}}),void 0===p.items.anyOf[0].properties.outOfRange&&(p.items.anyOf[0].properties.outOfRange={name:"未选中元素",isShow:!1,type:["Object"]}),"73"===r&&delete n.option.properties.visualMap}"1"===r&&void 0===n.option.properties.legend&&(n.option.properties.legend={name:"图例",isShow:!0,type:["Object"],properties:{show:{name:"是否显示",isShow:!0,type:["boolean"],descriptionCN:"",default:!0},left:{name:"水平对齐",isShow:!0,type:["button"],items:["center","left","right"],default:"center"},top:{name:"垂直对齐",isShow:!0,type:["button"],items:["top","middle","bottom"],default:"bottom"},orient:{name:"排列方式",isShow:!0,type:["button"],items:["horizontal","vertical"],default:"horizontal"},textStyle:{name:"文本样式",isShow:!1,type:["Object"],properties:{color:{name:"颜色",isShow:!1,type:["Color"],default:"#333"},fontStyle:{name:"斜体",isShow:!1,type:["button"],items:["normal","italic"],default:"normal"},fontWeight:{name:"粗体",isShow:!1,type:["button"],items:["normal","bold","bolder","lighter"],default:"normal"},fontFamily:{name:"字体",isShow:!1,type:["list"],items:["sans-serif","Microsoft YaHei"],default:"Microsoft YaHei"},fontSize:{name:"字号",isShow:!1,type:["number"],max:50,min:12,default:12}}},multiColor:{name:"单系列多彩",isShow:!0,type:["boolean"],default:!0}}});"34"===r&&"{b}"===n.option.properties.series.items.anyOf[0].properties.edgeLabel.properties.normal.properties.formatter.default&&(n.option.properties.series.items.anyOf[0].properties.edgeLabel.properties.normal.properties.formatter.default="");"76"===r&&"堆积柱线图"===n.option.name&&(r=e.compId="999");var c=n.data.properties;for(var l in c)c.hasOwnProperty(l)&&(l=c[l]).bind.forEach(function(e){e.hasOwnProperty("areaFlag")||(e.areaFlag=!1),e.hasOwnProperty("fieldSetting")||(e.fieldSetting={})});function h(){for(var e=null,t=null,r=null,i=null,a=1;a<o.length;a++)e=e>o[a][1]||null==e?o[a][1]:e,t=t<o[a][1]||null==t?o[a][1]:t,r=r>o[a][0]||null==r?o[a][0]:r,i=i<o[a][0]||null==i?o[a][0]:i;n.data.gisRange={minlat:e,maxlat:t,minlng:r,maxlng:i}}function u(e){for(var t=e.simpleJson.option.properties.series,r=t.items.anyOf[0].properties.data.items.anyOf.length,i=0,a=e.simpleJson.data.default,n=0;n<a.length;n++)for(var o=0;o<a[n].length;o++)if(a[n][o]){i++;break}if(r<--i)for(var s=i-r;0<s;){var d=angular.copy(_.last(t.items.anyOf[0].properties.data.items.anyOf)),p=angular.copy(_.last(t.items.anyOf[1].properties.data.items.anyOf));t.items.anyOf[0].properties.data.items.anyOf.push(d),t.items.anyOf[1].properties.data.items.anyOf.push(p),s--}else for(s=r-i;0<s;)t.items.anyOf[0].properties.data.items.anyOf.pop(),t.items.anyOf[1].properties.data.items.anyOf.pop(),s--}function f(e,t){var r=e.simpleJson.option.properties.series,i=r.items.anyOf.length,a=0;if(t){for(var n=[],o=e.simpleJson.data.default,s=0;s<o.length;s++)!_.contains(n,o[s][1])&&o[s][1]&&n.push(o[s][1]);a=(n=_.rest(n)).length}else a=1;if(i<a)for(var d=a-i;0<d;){var p=angular.copy(_.last(r.items.anyOf));r.items.anyOf.push(p),d--}else for(d=i-a;0<d;)r.items.anyOf.pop(),d--}function m(e){e&&e.length&&(e[0].areaFlag=!0)}function g(e){if(e&&e.length){var t=_.indexOf(o[0],e[0].name),r=_.uniq(_.pluck(_.rest(o),t));e[0].fieldSetting.sortRule=r}}switch(r){case"8":_.each(c.value.bind,function(e){e.fieldSetting.aggregation={description:null,formula:"sum",name:"求和",numericOnly:!0}});break;case"27":case"28":c.legend={bind:[],colorType:1,isMore:!1,name:"图例颜色",type:["string"]};break;case"54":case"55":case"993":m(c.geo.bind);break;case"56":void 0!==n.option.properties.series.items.anyOf[0].properties.symbolSize&&delete n.option.properties.series.items.anyOf[0].properties.symbolSize;break;case"39":case"992":m(c.geo.bind);break;case"38":m(c.source.bind),m(c.target.bind);break;case"61":case"62":case"67":h();break;case"37":m(c.geo.bind);break;case"65":_.each(c.timeField.bind,function(e){e.timeType=!0});break;case"997":case"996":case"995":case"994":g(c.time.bind);break;case"2076":m(c.map.bind),m(c.geo.bind);break;case"990":case"985":u(e);break;case"989":case"986":3<=o[0].length?f(e,!0):f(e,!1);break;case"988":g(c.time.bind)}var b=!1;e.tableOptions||(e.tableOptions={});var v=function(){for(var e=new Array(s.length),t=0;t<e.length;t++){for(var r in e[t]=[],c)for(var i=0;i<c[r].bind.length;i++){var a=c[r].bind[i].fieldName;if(void 0!==a&&(a=a.replace(new RegExp("（","gm"),"(").replace(new RegExp("）","gm"),")")),a===s[t]){e[t].push(c[r].name);break}}e[t]=e[t].join("/")}return e}();e.tableOptions.bindHint&&v.toString()===e.tableOptions.bindHint.toString()||(b=!0);return e.tableOptions.bindHint=v,n.data.properties=c,b},washUserData:function(e){var a=/^-?(((\uFFE5|\u0024|\u00A2|\u00A3|\u00A4|\u00A5|[\u20A0-\u20BE])(\d+\.?|\d+,?)+)|((\d+\.?|\d+,?)+(\uFFE5|\u0024|\u00A2|\u00A3|\u00A4|\u00A5|[\u20A0-\u20BE]))$)/,n=/^-?(\d+\.?|\d+,?)+%$/,o=/^-?(\d+\.?,?)+\d+$/,s=/^-?\d+(\.\d+)?$/,d=/^\s+|\s+$/,t=e.simpleJson,r=t.data.default,i=t.data.properties;if(!r||!i)return;for(var p=0;p<r[0].length;p++)"string"==typeof r[0][p]&&(r[0][p]=r[0][p].replace(new RegExp("（","gm"),"(").replace(new RegExp("）","gm"),")"));for(var c in i)if(i.hasOwnProperty(c)){var l=i[c].bind;if(!(l.length<1))for(p=0;p<l.length;p++){var h=l[p].fieldName,u=_.indexOf(r[0],h);-1<u&&_.each(r,function(e,t){var r=e[u];if("string"==typeof r&&0!==t){var i=r;a.test(i)&&(i=i.replace(/(\uFFE5|\u0024|\u00A2|\u00A3|\u00A4|\u00A5|[\u20A0-\u20BE])/,"")),n.test(i)&&(i=i.replace("%","")),d.test(i)&&(i=i.replace(d,"")),o.test(i)&&(i=i.split(",").join("")),i===r&&!s.test(i)||(e[u]=s.test(i)?parseFloat(i):i)}else null===r&&(e[u]=0)})}}},areaMatch:function(r,e){var t,i,a,n,o=g.defer(),s=window.tubiaoxiuOption.chartedit.echartsMapChart,d=0;if("56"!==r.compId&&-1!==s.indexOf(r.compId)&&e){var p=_.first(r.simpleJson.data.default),c=_.rest(r.simpleJson.data.default),l=r.simpleJson.data.properties;for(var h in l)if(l[h].bind[0]&&l[h].bind[0].areaFlag){d++,t=l[h].bind[0].name,i=p.indexOf(t),a=[],_.each(c,function(e){a.push(e[i])}),n=_.compact(_.uniq(a));var u={method:"POST",url:charts_server+"/service/charting/resource/areaMatch",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},data:"mapData="+n};m(u).then(function(e){if(e.data.error)console.error("areaMatch -- error"),f();else{var t=e.data.object.nameMap,n=r.simpleJson.data.default;_.map(t,function(i,a){_.each(i,function(e){for(var t=0;t<n.length;t++)if(n[t].includes(e))for(var r=0;r<n[t].length;r++)n[t][r]===i[0]&&(n[t][r]=a)})}),f()}})}var f=_.after(d,function(){o.resolve()})}else o.resolve();return o.promise},updateJsonDataDefaultWithUserData:n,calcConditionedData:function(e,t){if(e=n(e),!t||0==t.length)return e;for(var r=e.slice(1),i={},a=0;a<e[0].length&&e[0][a];a++)i[e[0][a]]=a;for(a=0;a<t.length;a++)i.hasOwnProperty(t[a].field.name)&&(r=_.filter(r,function(e){return-1!=_.indexOf(t[a].context.routine.matchValues,e[i[t[a].field.name]])})),0==r.length&&(r=e.slice(1));return r.splice(0,0,e[0]),r},convertFontSize:function i(a,n){if(a.properties)for(var e in a.properties)a.properties[e]&&(i(a.properties[e],n),"fontSize"===e||"fontsize"===e||"symbolSize"===e||"3dpieradius"===e||"3dpieyHeight"===e||"rightTextLineheight"===e||"symbolSizeMin"===e||"symbolSizeMax"===e?a.properties[e].default=a.properties[e].default*n:"padding"===e?a.properties[e].top&&a.properties[e].bottom&&a.properties[e].left&&a.properties[e].right&&(a.properties[e].top.default=a.properties[e].top.default*n,a.properties[e].bottom.default=a.properties[e].bottom.default*n,a.properties[e].left.default=a.properties[e].left.default*n,a.properties[e].right.default=a.properties[e].right.default*n):"grid"===e?a.properties[e].properties&&a.properties[e].properties.top&&a.properties[e].properties.bottom&&a.properties[e].properties.left&&a.properties[e].properties.right&&(a.properties[e].properties.top.default=a.properties[e].properties.top.default*n,a.properties[e].properties.bottom.default=a.properties[e].properties.bottom.default*n,a.properties[e].properties.left.default=a.properties[e].properties.left.default*n,a.properties[e].properties.right.default=a.properties[e].properties.right.default*n):"width"===e&&"线宽"===a.properties[e].name?a.properties[e].max?a.properties[e].default=Math.min(a.properties[e].default*n,a.properties[e].max):a.properties[e].default=a.properties[e].default*n:"borderWidth"===e&&"描边线宽"===a.properties[e].name?a.properties[e].max?a.properties[e].default=Math.min(a.properties[e].default*n,a.properties[e].max):a.properties[e].default=a.properties[e].default*n:"itemWidth"===e&&"图例标记宽度"===a.properties[e].name?a.properties[e].max?a.properties[e].default=Math.min(a.properties[e].default*n,a.properties[e].max):a.properties[e].default=a.properties[e].default*n:"itemHeight"===e&&"图例标记高度"===a.properties[e].name&&(a.properties[e].max?a.properties[e].default=Math.min(a.properties[e].default*n,a.properties[e].max):a.properties[e].default=a.properties[e].default*n));else{if(!a.items||!a.items.anyOf)return;_.each(a.items.anyOf,function(e,t){for(var r in a.items.anyOf[t].properties)i(a.items.anyOf[t].properties[r],n),"fontSize"===r||"fontsize"===r||"symbolSize"===r||"3dpieradius"===r||"3dpieyHeight"===r?a.items.anyOf[t].properties[r].default=a.items.anyOf[t].properties[r].default*n:"padding"===r?a.items.anyOf[t].properties[r].properties&&(a.items.anyOf[t].properties[r].properties.top.default=a.items.anyOf[t].properties[r].properties.top.default*n,a.items.anyOf[t].properties[r].properties.bottom.default=a.items.anyOf[t].properties[r].properties.bottom.default*n,a.items.anyOf[t].properties[r].properties.left.default=a.items.anyOf[t].properties[r].properties.left.default*n,a.items.anyOf[t].properties[r].properties.right.default=a.items.anyOf[t].properties[r].properties.right.default*n):"grid"===r&&a.properties[r].properties&&a.properties[r].properties.top&&a.properties[r].properties.bottom&&a.properties[r].properties.left&&a.properties[r].properties.right&&(a.properties[r].properties.top.default=a.properties[r].properties.top.default*n,a.properties[r].properties.bottom.default=a.properties[r].properties.bottom.default*n,a.properties[r].properties.left.default=a.properties[r].properties.left.default*n,a.properties[r].properties.right.default=a.properties[r].properties.right.default*n)})}}};function a(e){for(var t=0,r=p.dataSetBindings.length;t<r;t++){var i=p.dataSetBindings[t];if(-1!==_.indexOf(e,i.ds1)){if(-1===_.indexOf(e,i.ds2))return{dsId:i.ds2,bindings:i,over:t===r-1}}else if(-1!==_.indexOf(e,i.ds2))return{dsId:i.ds1,bindings:i,over:t===r-1}}}function n(e,t,r){return e=angular.copy(e),e=i.determineDataAndDirection(e).data,t?(e=i.mergeHeaders(e),e=i.cross2list(e,!0,r).newData):"horizontal"===r&&(e=i.transposeJsonArray(e)),e}}]).controller("chartCtrl",["$scope","chartService","$modal",function(b,n,o){var t=this,v={prefix:{dateModel:{all:["年","年-季度","年-月","年-周","年-月-日"],key:["Y","Y-Q","Y-M","Y-W","Y-M-D"],init:[0,2,5]},timeModel:{all:["时","时:分","时:分:秒"],key:["h","h:m","h:m:s"],init:[0,1]},datetimeModel:{all:["年","年-季度","年-月","年-周","年-月-日","时","时:分","时:分:秒","年-月-日 时:分:秒"],key:["Y","Y-Q","Y-M","Y-W","Y-M-D","h","h:m","h:m:s","Y-M-D h:m:s"],init:[0,2,5]}},noPrefix:{dateModel:{all:["年","季度","月","周","日"],key:["Y","Q","M","W","D"],init:[0,2,5]},timeModel:{all:["时","分","秒"],key:["h","m","s"],init:[0,1]},datetimeModel:{all:["年","季度","月","周","日","时","分","秒"],key:["Y","Q","M","W","D","h","m","s"],init:[0,2,5]}}},x=[{name:"带前缀",prefix:!0},{name:"不带前缀",prefix:!1}],r={string:"维度（字符）",number:"度量（数值）",time:"维度（时间）",map:"维度（地理位置）"};function y(e){var t=[];for(var r in e)"number"!==e[r].type[0]&&(t=t.concat(e[r].bind));return t}function w(e,t,r,i,a,n){var o={isTemp:!0,trigger:{chartId:a,type:n},context:{routine:{active:!0,matchValues:[],others:!1},wildcard:{active:!1,matchType:"isEmpty",matchValue:"",others:!1}},field:{dataSetId:r,name:e,timeKey:i,role:"string",type:"string"}};return o.context.routine.matchValues.push(function(e,t){var r,i;if(!t)return e;switch(t){case"Y-Q":r=/(\d{1,4})年(\d{1})季度/,i="$1 $2";break;case"Y-M":r=/(\d{1,4})年(\d{1,2})月/,i="$1-$2";break;case"Y-W":r=/(\d{1,4})年第(\d{1,2})周/,i="$1 $2";break;case"Y-M-D":r=/(\d{1,4})年(\d{1,2})月(\d{1,2})日/,i="$1-$2-$3";break;case"h:m":r=/(\d{1,2})时:(\d{1,2})分/,i="$1:$2";break;case"h:m:s":r=/(\d{1,2})时:(\d{1,2})分:(\d{1,2})秒/,i="$1:$2:$3";break;case"Y-M-D h:m:s":r=/(\d{1,4})年(\d{1,2})月(\d{1,2})日(\d{1,2})时:(\d{1,2})分:(\d{1,2})秒/,i="$1-$2-$3 $4:$5:$6";break;default:r=/\D+/,i=""}return e.replace(r,i)}(t+"",i)),o}t.setOptions=function(e){if(!e)return;e=angular.extend({},e),angular.extend(t,e)},t.setDom=function(e,t){var r=t.find(".chart");if(0===r.length){var i=document.createElement("div");i.style.width="100%",i.style.height="100%",i.setAttribute("class","chart chartshowid"),e.dom=i,t.append(i);var a=document.createElement("div");a.style.position="absolute",t.append(a)}else e.dom=r[0];return e},t.setId=function(e){e.id||(e.id=UUID.prototype.createUUID(""));return e},t.setDecimals=function(n,e){_.each(e,function(e){if(e.fieldSetting&&e.fieldSetting.decimal)for(var t=_.indexOf(n[0],e.name),r=parseInt(e.fieldSetting.decimal.value),i=1,a=n.length;i<a;i++)n[i][t]=n[i][t].toFixed(r)})},t.initInstance=function(e,t){return datavizCharts.initInstance(e,t)},t.readyToRender=function(e,require){if(!e||!require)return!1;var t=e.data.properties,r={string:0,map:0,time:0,number:0};for(var i in t)switch(t[i].type[0]){case"string":r.string+=t[i].bind.length;break;case"map":r.map+=t[i].bind.length;break;case"time":r.time+=t[i].bind.length;break;case"number":r.number+=t[i].bind.length}for(var i in require)"n"==require[i]?require[i]=1:"m"==require[i]&&(require[i]=2);return r.string>=require.string&&r.number>=require.number&&r.map>=require.map&&r.time>=require.time||{string:require.string-r.string,number:require.number-r.number,map:require.map-r.map,time:require.time-r.time}},t.generateRequireStr=function(require){var e=[];for(var t in require)0<require[t]&&e.push("拖拽"+require[t]+"个"+r[t]);return e},t.getBindFields=function(e){var t=[];for(var r in e)t.push(e[r].bind);return _.flatten(t)},t.getInstanceByDom=function(e){return datavizCharts.getInstanceByDom(e)},t.setDrill=function(e,d,p,c,l){var h,s,u,r,f,m,i;l=l;if(_.each(d,function(e,t){e.hierarchy&&(u=t,1<=(r=e.hierarchyIndex)&&(s=e.hierarchy[r-1].name),r<e.hierarchy.length-1&&(h=e.hierarchy[r+1].name))}),h){var t="下钻至"+h,g="drillDown";e.setContextMenu(t,function(e){if(f=d[u].fieldName,m=d[u].name,d[u].timeKey){var t,r,i=d[u].timeHierarchyType,a=d[u].timeType,n=d[u].hierarchyIndex,o=d[u].hierarchy,s=d[u].timeKey;t=i===x[0].name?"prefix":"noPrefix",r=_.indexOf(v[t][a].all,o[n+1].name),d[u].timeKey=v[t][a].key[r]}else d[u].fieldName=h;d[u].hierarchyIndex++,p.push(w(f,e[m],c,s,l,g)),b.$broadcast("dataviz-chart-render",{updateData:!0})})}if(s){var a="上卷至"+s;g="rollUp";e.setContextMenu(a,function(e){if(d[u].timeKey){var t,r,i=d[u].timeHierarchyType,a=d[u].hierarchy,n=d[u].timeType,o=d[u].hierarchyIndex;t=i===x[0].name?"prefix":"noPrefix",r=_.indexOf(v[t][n].all,a[o-1].name),d[u].timeKey=v[t][n].key[r]}else d[u].fieldName=s;d[u].hierarchyIndex--,p.pop(),b.$broadcast("dataviz-chart-render",{updateData:!0})})}"详细信息",i=y(e.option.data.properties);e.setContextMenu("详细信息",function(t){var r=angular.copy(p);_.each(i,function(e){r.push(w(e.fieldName,t[e.name],c,e.timeKey,l,"drillThrough"))}),n.getDrillThroughData(c,r).then(function(e){o.open({controller:"drillThroughCtrl",templateUrl:"modules/chartedit/chart/drillThrough.html",backdrop:!0,size:"lg",resolve:{data:function(){return e}}})})})},t.generateTempCond=function(e,t,r,i){var a=y(e),n=[];return _.each(a,function(e){n.push(w(e.fieldName,t[e.name],r,e.timeKey,i,"interactive"))}),n},t.formatTimeData=function(e,t){for(var r,i,a,n,o,s=0,d=e[0].length;s<d;s++)for(var p=0,c=t.length;p<c;p++)if(e[0][s]===t[p].name&&t[p].timeKey){r=s,i=t[p].hierarchy[t[p].hierarchyIndex].name,a=t[p].timeKey;break}if(!a)return;switch(a){case"Y-Q":n=/(\d{1,4}) (\d{1})/,o="$1年$2季度";break;case"Y-M":n=/(\d{1,4})-(\d{1,2})/,o="$1年$2月";break;case"Y-W":n=/(\d{1,4}) (\d{1,2})/,o="$1年第$2周";break;case"Y-M-D":n=/(\d{1,4})-(\d{1,2})-(\d{1,2})/,o="$1年$2月$3日";break;case"h:m":n=/(\d{1,2}):(\d{1,2})/,o="$1时:$2分";break;case"h:m:s":n=/(\d{1,2}):(\d{1,2}):(\d{1,2})/,o="$1时:$2分:$3秒";break;case"Y-M-D h:m:s":n=/(\d{1,4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})/,o="$1年$2月$3日$4时:$5分:$6秒";break;default:n=/$/,o=i}for(s=1,d=e.length;s<d;s++)e[s][r]=e[s][r].replace(n,o);return e},t.verifyData=function(e){return _.each(e,function(e){_.each(e,function(e){if(null===e)return!1})}),!0},t.isLazyLoad=function(){return"58"===b.chartObj.compId},t.isTableChart=function(){return"8"===b.chartObj.compId||"58"===b.chartObj.compId}}]).controller("drillThroughCtrl",["$scope","data","$modalInstance",function(t,r,e){var i,a;t.currentPage=1,t.currentPagination=0,t.header=r.shift(),i=r.length/10,t.listLength=r.length,i>Math.floor(i)?t.pageLength=Math.floor(i)+1:t.pageLength=i,a=(a=t.pageLength/5)>Math.floor(a)?Math.floor(a)+1:a,t.data=r.slice(0,10),5*t.currentPagination+5+1>t.pageLength?t.pageNumber=_.range(5*t.currentPagination+1,t.pageLength+1):t.pageNumber=_.range(5*t.currentPagination+1,5*t.currentPagination+5+1),t.index=0,t.selectPage=function(e){t.currentPage=5*t.currentPagination+e+1,t.data=r.slice(10*(t.currentPage-1),10*t.currentPage),t.index=e},t.leftPage=function(e){0!==t.currentPagination&&(t.currentPagination--,t.currentPage=t.index+5*t.currentPagination+1,t.data=r.slice(10*(t.currentPage-1),10*t.currentPage),t.pageNumber=_.range(5*t.currentPagination+1,5*t.currentPagination+5+1))},t.rightPage=function(){t.currentPagination!==a-1&&(t.currentPagination++,t.currentPage=t.index+5*t.currentPagination+1,t.currentPage>t.pageLength&&(t.currentPage=t.pageLength,t.index=t.currentPage-5*t.currentPagination-1),5*t.currentPagination+5+1>t.pageLength?t.pageNumber=_.range(5*t.currentPagination+1,t.pageLength+1):t.pageNumber=_.range(5*t.currentPagination+1,5*t.currentPagination+5+1),t.data=r.slice(10*(t.currentPage-1),10*t.currentPage))},t.dismiss=function(){e.close(!1)}}]).controller("addComponentsCtrl",["$scope","$rootScope","$modalInstance","$http","toaster","widget",function(r,e,t,i,a,n){r.form={},r.iconCountLimit=e.userinfo.limit.iconcount,i.get("assets/icon/icons.json").then(function(e){r.icons=e.data,"img"===n.type?r.form.componentType="img":"icon"===n.type?(r.form.componentType="icon",r.form.setIconColor=n.resource.setIconContent,r.form.iconContent=n.resource.iconContent,r.colorPicker={"background-color":n.resource.setIconContent},r.iconColor={color:n.resource.setIconContent},r.lastIconIndex=r.icons.indexOf(r.form.iconContent)):(r.lastIconIndex=0,r.form.componentType="icon",r.form.setIconColor="rgb(102, 102, 102)",r.form.iconContent=r.icons[r.lastIconIndex],r.colorPicker={"background-color":r.form.setIconColor},r.iconColor={color:r.form.setIconColor})}),r.chooseIcon=function(e){var t=$(".modal-icons-components");e!==r.lastIconIndex?(t[r.lastIconIndex].classList.remove("modal-icons-components-active"),t[e].classList.add("modal-icons-components-active"),r.lastIconIndex=e):t[e].classList.add("modal-icons-components-active"),r.form.iconContent=r.icons[r.lastIconIndex]},r.$on("iconColorChange",function(e,t){r.form.setIconColor=t,r.$apply(function(){r.colorPicker={"background-color":t},r.iconColor={color:t}})}),r.$watch("form.img",function(){"img"===r.form.componentType&&r.form.img&&r.submit()}),r.submit=function(){"icon"===r.form.componentType&&-1!==r.iconCountLimit&&r.lastIconIndex>r.iconCountLimit?a.pop("info","","该图标为银会员所有"):t.close(r.form)},r.dismiss=function(){t.dismiss()}}]).directive("datavizChart",["chartService","$rootScope","$stateParams","$timeout","themeService","toaster","$q","userDataService","getDataService","getDataConfig",function(b,v,e,x,y,w,I,k,O,C){return{restrict:"A",transclude:!0,scope:{config:"=",chartObj:"=",themeId:"=",widget:"=",mode:"=",largeTextRatio:"="},template:'<div class="pos-rlt w-full h-full" ng-hide="hideSketch" style="position: absolute;"><div ng-if="showError" class="text-center chart-error-message" style="color: #aaaaaa; font-size: 18px;position: absolute;width: 100%;left: 50%;top: 50%;transform: translate(-50%, -50%);">图表：{{errorChartName}}<br>未能成功渲染，请检查数据格式是否正确</div></div>',controller:"chartCtrl",link:function(s,d,e,p){var c,l,h,a,u;s.hideSketch=!1,s.chartRequire,s.isFirstRender=!0;var r={getGroupCounts:function(e){var t=I.defer(),r=[],i=[];return r.push(_.rest(s.chartObj.userData).length),i.push(r),t.resolve(i),t.promise},getGroupData:function(e,t){var r=I.defer();return b.getGroupData(s.chart.dataset.id,bindFields,a,s.chart.simpleJson.data.rawConditions,dataSetBindings,e,s.chart.id,t).then(function(e){1!=e.length||t?s.chart.simpleJson.dom&&(s.chart.simpleJson.dom.style.display=null):(remindNoData(),s.chart.simpleJson.dom&&(s.chart.simpleJson.dom.style.display="none")),sortService.sort(s.chart.dataset.id,bindFields,a,dataSetBindings,e,s.chart.id).then(function(e){var t=checkData(e,bindFields,s.chart.compId);r.resolve({data:transformData(t,c.option.data.properties)})})},function(){remindDataFailed(),r.reject()}),r.promise},getPageData:function(e,t,r){var i=I.defer(),a={};return a.data=angular.copy(s.chartObj.userData),i.resolve(a),i.promise},getTotal:function(e,t){var r=I.defer(),i=_.map(_.initial(e[0]),function(){return 0});return _.each(_.rest(e),function(e){_.map(_.rest(e),function(e,t){i[t]=Number(e)+i[t]})}),r.resolve(i),r.promise},getBindData:function(e){var t=I.defer(),r={};return r.data=angular.copy(s.chartObj.userData),t.resolve(r),t.promise}},i={getGroupData:function(r,e){var i=I.defer();return b.getGroupData(s.chart.dataset.id,r,a,s.chart.simpleJson.data.rawConditions,dataSetBindings,null,s.chart.id,e).then(function(e){var t=checkData(e,r,s.chart.compId);i.resolve({data:transformData(t,c.option.data.properties)})},function(){remindDataFailed(),i.reject()}),i.promise}};p.setOptions(s.config),s.tempChartObjHandle=function(e){if(void 0!==s.largeTextRatio&&1!==parseFloat(s.largeTextRatio)&&b.convertFontSize(e.simpleJson.option,s.largeTextRatio),e.simpleJson.option.properties&&(e.simpleJson.option=b.metaJsonToSimpleJson(e.simpleJson.option.properties)),"exportChart"===s.mode&&void 0!==e.simpleJson.option.timeline&&(e.simpleJson.option.timeline.autoPlay=!1),"exportChart"!==s.mode&&"playChart"!==s.mode||"71"===e.compId&&(e.simpleJson.option.globe.environment="./src/assets/chart/resource/data-universal.jpg",e.simpleJson.option.globe.baseTexture="./src/assets/chart/resource/data-globe.jpg",e.simpleJson.option.globe.heightTexture="./src/assets/chart/resource/data-globe.jpg"),"58"===s.chartObj.compId){datavizCharts.registerAsyncDataLoad({type:"datalist",compIds:["58"],use:r});var t=!0;e.simpleJson.option.extraInfo={updateData:t,needSort:null}}else if("8"===s.chartObj.compId){datavizCharts.registerAsyncDataLoad({type:"pivot",compIds:["8"],use:i});t=!0;e.simpleJson.option.extraInfo={updateData:t}}e.simpleJson=p.setDom(e.simpleJson,d),e.simpleJson.option.compId=e.compId},s.drawChart=_.debounce(function(e,n,t,r,o){function i(){if(s.chartObj.userData){if(0===s.chartObj.simpleJson.data.default.length)s.chartObj.simpleJson.data.default=angular.copy(s.chartObj.userData);else if(r){if(r.toString()===s.chartObj.simpleJson.data.default.toString())return;s.chartObj.simpleJson.data.default=r}t&&b.defaultUserDataBind(s.chartObj),b.specialProcessChart(s.chartObj,!t),b.washUserData(s.chartObj),b.areaMatch(s.chartObj,e).then(function(){l=angular.copy(s.chartObj),s.tempChartObjHandle(l),y.registerThemeToChart(h,l,!n),s.widget&&s.widget.themeChanged&&delete s.widget.themeChanged,c&&!c._isDisposed||(c=p.initInstance(l.simpleJson.dom,h));var e=angular.copy(l.simpleJson.option),t=angular.copy(l.simpleJson.data);if(o||function(e,t){tubiaoxiuOption.chartedit.ichartCharts.includes(e.compId)?e.series[0].animation=t:e.animation=t}(e,o),c.setOptionAndData(e,t,l.compId,n&&h),n){var r=y.getThemeById(h);c.setChartJsonColor(r.define,l.simpleJson.option),c.themeChanged=!0;var i=angular.copy(l.simpleJson.option),a=angular.copy(l.simpleJson.data);c.setOptionAndData(i,a,l.compId,n&&h)}else c.themeChanged=!1;!function(a){a.on("click",function(e,t){if(s.widget&&s.widget.props&&s.widget.props.asFilter&&s.widget.props.asFilter){var r=p.generateTempCond(s.chartObj.simpleJson.data.properties,t,"0",s.chartObj.id),i=a.interactive.highlight?"interaction-trigger-emit":"interaction-recover-emit";a.interactive.highlight,b.setInteractiveStatus(s.chartObj.id,t),v.$broadcast(i,{tempConditions:r,chartId:s.chartObj.id,type:"interactive"})}})}(c);try{c.render(!1,function(){s.chartObj.isRenderError=!1,s.$emit("chartRenderDone")})}catch(e){throw x(function(){s.errorChartName=s.chartObj.simpleJson.option.properties.title?s.chartObj.simpleJson.option.properties.title.properties.text.default:s.chartObj.name,s.showError=!0,s.chartObj.isRenderError=!0,c.dispose()},0),e}finally{s.chartObj.id||(s.chartObj.id=UUID.prototype.createUUID("")),$(d).addClass("CHARTID_"+s.chartObj.id),n&&(v.$broadcast("setPropertyWatchRevoke"),s.chartObj.simpleJson.option.properties=b.simpleJsonToMetaJson(l.simpleJson.option,s.chartObj.simpleJson.option)),(u=b.getInteractiveStatus(s.chartObj.id))&&c.highlight(u),s.isFirstRender=!1}})}}s.showError=!1,s.errorChartName="",s.themeId&&(h=s.themeId,n=n||void 0!==s.widget&&s.widget.themeChanged,a=s.chartObj.simpleJson.data.conditions,s.chartObj.dataQuery?O.getDsIdData(C.dsIdDataRest,s.chartObj.dataQuery).then(function(e){if(e.data.error)w.pop("error","",e.data.error.m);else{var t=JSON.parse(e.data.object);if(0===t.length)w.info("URL数据源数据为空");else{s.chartObj.userData=t;var r=angular.copy(t);s.chartObj.dataCrosstab?(r=k.mergeHeaders(r),r=k.cross2list(r,!0,s.chartObj.dataOrientation).newData):"horizontal"===s.chartObj.dataOrientation&&(r=k.transposeJsonArray(r)),s.chartObj.simpleJson.data.default=r,i()}}}):i())},100),s.dispose=function(){if(s.chartObj.simpleJson.dom&&""!==s.chartObj.simpleJson.dom&&(c=p.getInstance(s.chartObj.simpleJson)).instance)for(var e in c.dispose(),s.chartObj.simpleJson.data.properties)s.chartObj.simpleJson.data.properties[e].bind=[]};var t=s.$on("drawChart",function(e,t){var r=!1,i=!1,a=!1,n=null,o=!0;t&&(r=!!t.isAreaMatch&&t.isAreaMatch,i=!!t.isThemeChanged&&t.isThemeChanged,a=!!t.isDefaultDataBind&&t.isDefaultDataBind,n=t.newData?t.newData:null,o=void 0===t.isOpenAnimation||t.isOpenAnimation),s.drawChart(r,i,a,n,o)});function n(e){var t=k.determineDataAndDirection(e.userData);return e.dataCrosstab?k.cross2list(t.data,!0,e.dataOrientation).newData:"horizontal"===e.dataOrientation?k.transposeJsonArray(t.data):t.data}var o=s.$on("interaction-trigger-broadcast",function(e,t){if(s.widget&&s.widget.props&&!s.widget.props.notAccept&&s.chartObj.id!==t.chartId){var r=b.calcConditionedData(n(s.chartObj),t.tempConditions);s.drawChart(!0,!1,!1,r,!0)}}),f=s.$on("interaction-recover-broadcast",function(e,t){s.widget&&s.widget.props&&!s.widget.props.notAccept&&s.chartObj.id!==t.chartId&&s.drawChart(!0,!1,!1,_.filter(n(s.chartObj),function(e){return!!e[0]}),!0)}),m=s.$on("drawChartExport",function(e,t){if("chartExportDiv"===d[0].getAttribute("id")){var r=!1,i=!1,a=!1,n=null,o=!0;t&&(r=!!t.isAreaMatch&&t.isAreaMatch,i=!!t.isThemeChanged&&t.isThemeChanged,a=!!t.isDefaultDataBind&&t.isDefaultDataBind,n=t.newData?t.newData:null,o=void 0===t.isOpenAnimation||t.isOpenAnimation),s.drawChart(r,i,a,n,o)}}),g=s.$on("recoverJsonDataToUserData",function(e,t){s.chartObj.simpleJson.data.default=b.updateJsonDataDefaultWithUserData(s.chartObj.userData,s.chartObj.dataCrosstab,s.chartObj.dataOrientation),t&&s.drawChart(!0,!1)});s.$on("$destroy",function(){c&&(c.dispose(),d.off("click")),t(),o(),f(),m(),g(),clearInterval(void 0)}),s.$emit("chartReadyToRender"),s.resizeChart=_.debounce(function(){if(!_.isEmpty(s.chartObj)&&!_.isEmpty(s.chartObj.simpleJson)&&c&&c.dom&&c.dom.nodeName)try{c.resize()}catch(e){console.error(e)}}),d.resize(s.resizeChart)}}}]).directive("widgetItemV2",["$rootScope","$modal","$state","$timeout","$sessionStorage","$sce","$compile","$http","Upload","chartLibraryManager","toaster","StatisticsService","vipService","chartExportService","UndoService","chartInstanceInfoManager","MEDIA_TYPES",function(n,o,s,d,p,c,e,t,r,l,h,u,i,f,m,g,b){return{restrict:"AE",replace:!0,scope:{widget:"=",widgetIndex:"=",pageIndex:"=",isLastWidget:"=",bookId:"=",bookName:"=",curTheme:"=",textColor:"=",isNavi:"@",compatVersion:"=",chartBookInfo:"=",chartInstancesInfo:"="},templateUrl:"tpl/charting/widgetItem_v2.html",link:function(r,i,e){function t(e){return"chart"===(e=angular.copy(e)).type&&(e.resource.id=UUID.prototype.createUUID("")),e.define=r.widget.define,e.props=r.widget.props,e}r.ciCustomEvent=u.ciCustomEvent,r.undoManager=m.getManager("bookEdit"),r.isNavi||(r.isSelectChart=0<r.chartInstancesInfo.length),_browserDetect.ie<10&&(r.isIE9=!0),i.bind("dblclick",function(){if(!r.isNavi)switch(r.widget.type){case"chart":r.editChart();break;case"text":r.editText();break;case"icon":r.editIcon()}}),r.chartGifSupport=!1,r.$on("chartRenderDone",function(){if("chart"===r.widget.type){var e=$(".CHARTID_"+r.widget.resource.id+" .chartshowid");r.chartGifSupport=datavizCharts.getInstanceByDom(e[0]).instance.exportToGif}}),r.$on("chartInstanceQueryDone",function(){r.isNavi||d(function(){r.isSelectChart=0<r.chartInstancesInfo.length})}),r.trustAsHtml=c.trustAsHtml,r.addText=function(){r.oldWidget=angular.copy(r.widget),r.firstAddText=!0,r.widget.type="text",r.widget.resource={},r.widget.resource.content="",r.isSavedToServer=!1,r.editText()},r.editText=function(){r.editorFlag=!0,r.textFlag=!1},r.$on("textEditDone",function(e){e.stopPropagation&&e.stopPropagation(),d(function(){r.editorFlag=!1,r.textFlag=!0,r.$emit("updateWidget",{pageIndex:r.pageIndex,widgetIndex:r.widgetIndex,widget:angular.copy(r.widget),oldWidget:angular.copy(r.oldWidget)})},0)}),r.$on("textEditStart",function(e){e.stopPropagation&&e.stopPropagation(),d(function(){r.editorFlag=!0,r.textFlag=!1,r.firstAddText?r.firstAddText=!1:r.oldWidget=angular.copy(r.widget),setTimeout(function(){var e=document.querySelector(".cke"),t=document.querySelector(".cke").style.top;r.style=document.createElement("style"),r.style.innerText="#"+e.id+"{top: "+t+" !important}",document.head.appendChild(r.style)})},0)}),r.addChart=function(){n.isSavedToServer=!1,s.go("app.chart_instance_dashboard",{chartBookId:r.bookId,pageIndex:r.pageIndex,widgetIndex:r.widgetIndex,curTheme:r.curTheme,actionType:"selectChart"})},r.addExistChart=function(){g.query().then(function(e){r.chartInstancesInfo=e,o.open({templateUrl:"tpl/charting/select_exist_chart.html",controller:"selectExistChartCtrl",size:"lg",scope:r})})},r.editChart=function(){l.getById(r.widget.resource.compId,r.compatVersion).then(function(e){!e.onSale||e.chartOwning&&!e.chartOwning.isExpired?(n.isSavedToServer=!1,s.go("app.chart_instance_dashboard",{chartBookId:r.bookId,pageIndex:r.pageIndex,widgetIndex:r.widgetIndex,curTheme:r.curTheme,actionType:"selectChart"})):o.open({templateUrl:"tpl/security/product_warning_modal.html",controller:"productExpiredWarningModalCtrl",size:"sm",resolve:{params:function(){return angular.copy({msgs:[e.chartOwning?"该图表已过期":"该图表为高级图表","钻石会员可用","或者前往商城单独购买使用"],showVipRedirect:!0,submitText:e.chartOwning?"去续期":"去购买",url:mall_server+(e.productUrl?e.productUrl:"")})}}})})},r.exportChart=function(){f.exportChart(r.widget.resource)},r.exportChartPng=function(){f.exportChartPng(r.widget.resource)},r.exportChartGif=function(){f.exportChartGif(r.widget.resource)},r.addImageOrIcon=function(){o.open({templateUrl:"tpl/charting/media_library.html",controller:"MediaLibraryCtrl",backdrop:"static",windowClass:"media-lib",resolve:{types:function(){return angular.copy([b.IMAGE,b.ICON])},musicMediaSaved:function(){return null}}}).result.then(function(e){r.oldWidget=angular.copy(r.widget);var t=angular.copy(r.widget);e.type===b.IMAGE?(t.type="image",t.resource={},t.resource.imageStore=e.path):e.type===b.ICON&&(t.type="icon",t.resource={},t.resource.iconContent=e.iconContent,t.resource.setIconContent=e.setIconColor,t.resource.iconFontSize=i.children().last().width()>i.children().last().height()?i.children().last().height():i.children().last().width()),n.isSavedToServer=!1,r.$emit("updateWidget",{pageIndex:r.pageIndex,widgetIndex:r.widgetIndex,widget:t,oldWidget:angular.copy(r.oldWidget)})})},r.copyWidget=function(){r.widget.type&&(p.widget={type:r.widget.type,resource:r.widget.resource,props:r.widget.props,compatVersion:r.compatVersion},h.pop("success","","内容已复制，按下Ctrl+V粘贴。"))},r.pasteWidget=function(){p.widget&&("chart"!==p.widget.type||p.widget.compatVersion===r.compatVersion?r.widget.type?o.open({templateUrl:"tpl/charting/operationConfirm.html",size:"sm",controller:["$scope","$modalInstance",function(e,t){e.message="要替换当前内容吗？",e.dismiss=function(){t.dismiss()},e.submit=function(){t.close()}}]}).result.then(function(){r.$emit("updateWidget",{pageIndex:r.pageIndex,widgetIndex:r.widgetIndex,widget:t(p.widget)})}):r.$emit("updateWidget",{pageIndex:r.pageIndex,widgetIndex:r.widgetIndex,widget:t(p.widget)}):h.pop("info","","图册版本不兼容，不能粘贴图表"))},r.clearWidget=function(){r.$emit("updateWidget",{pageIndex:r.pageIndex,widgetIndex:r.widgetIndex,widget:{type:null,resource:{},props:{asFilter:!1,notAccept:!1},define:r.widget.define}})},r.removeWidget=function(){r.$emit("removeWidget",r.widgetIndex)},r.$on("gridster-item-resized-end",function(){"icon"!==r.widget.type||r.isNavi||(r.widget.resource.iconFontSize=i.children().last().width()>i.children().last().height()?i.children().last().height():i.children().last().width())}),r.$on("iconColorChange",function(e,t){r.isNavi||_.isEmpty(r.widget.resource)||"icon"!=r.widget.type||(r.widget.resource.setIconContent=t)}),r.$watch("widget.type",function(e,t){"chart"===e&&d(function(){r.$broadcast("drawChart")})});var a=r.$on("gridster-item-resized",_.debounce(function(e,t){r.hasInited&&(n.isSavedToServer=!1)},100));r.$on("$destroy",function(){a()})}}}]).directive("chartInteraction",["userDataService",function(e){return{restrict:"AE",scope:{widgetIndex:"=",widget:"="},templateUrl:"tpl/charting/interaction_v2.html",link:function(e,t,r){}}}]).directive("helpNavigation",["$rootScope","$state",function(t,i){return{restrict:"AE",scope:!0,templateUrl:"tpl/charting/helpNavigation.html",link:function(r,a,e){r.step=e.step,r.$watch("step",function(e,t){r.switchStep(e)}),r.switchStep=function(e){switch(e){case"first":r.helpBoxClass="first",r.textBox={top:"50px"},r.helpText="点击新建图册，开启图表秀之旅",r.helpEnd=t.isEverLogin?r.closeHelp:r.createChartbook,r.prevText={display:"none"},r.endText=t.isEverLogin?"我知道啦":"下一步";break;case"firstChart":r.helpBoxClass="firstChart",r.textBox={left:"50px"},r.helpText="点击新建图表，创建独有的酷炫图表",r.helpEnd=t.isEverLogin?r.closeHelp:r.createChartInstance,r.prevText={display:"none"},r.endText=t.isEverLogin?"我知道啦":"下一步";break;case"second":r.helpBoxClass="second",r.textBox={top:"50px"},r.helpText="制作的图册可以导出和分享哦~",r.helpEnd=function(){r.step="three"},r.endText="下一步",r.prevText={display:"none"};break;case"three":r.helpBoxClass="three",r.textBox={left:"50px"},r.helpText="点击加号可以添加图册页~",r.helpEnd=r.closeHelp,r.prevText={color:"#07bf84"},r.helpPrev=function(){r.step="second"},r.endText="我知道啦";break;case"forth":localStorage.setItem("showChartInstanceHelp",!0),r.accordionGroupType.open=!0,r.accordionGroupOption.open=!1,r.helpBoxClass="forth",r.textBox={right:"310px"},r.helpText="选择图表（80+种图表任意选择）",r.helpEnd=function(){r.step="fifth"},r.prevText={display:"none"},r.endText="下一步",setTimeout(function(){a.children().attr("style","")});break;case"fifth":r.helpBoxClass="fifth",r.textBox={right:"310px"},r.helpText="点击编辑图表数据",r.helpEnd=function(){r.step="chartSixth",r.changeAccordion(),$("help-navigation").hide()},r.helpPrev=function(){r.step="forth"},r.prevText={color:"#07bf84"},r.endText="下一步",setTimeout(function(){a.children().attr("style",""),a.children().css("left",$("#edit-data-button").position().left),$("help-navigation").show()});break;case"chartSixth":r.helpBoxClass="sixth",r.textBox={right:"310px"},r.helpText="手动输入或上传数据文件",r.helpEnd=function(){r.step="chartSeventh"},r.helpPrev=function(){$("help-navigation").hide(),r.step="fifth",r.changeAccordion()},r.prevText={color:"#07bf84"},r.endText="下一步",setTimeout(function(){a.children().attr("style",""),$("help-navigation").show()});break;case"chartSeventh":r.helpBoxClass="fifth",r.textBox={right:"310px"},r.helpText="点击修改图表属性",r.helpEnd=function(){r.step="sixth",$("help-navigation").hide(),r.changeAccordion()},r.helpPrev=function(){r.step="chartSixth",r.changeAccordion()},r.prevText={color:"#07bf84"},r.endText="下一步",setTimeout(function(){a.children().attr("style",""),a.children().css("left",$("#edit-data-button").position().left)});break;case"sixth":r.accordionGroupType.open=!1,r.accordionGroupOption.open=!0,r.helpBoxClass="sixth",r.textBox={right:"310px"},r.helpText="修改图表属性，给你的图表化化妆",r.helpEnd=function(){r.step="seventh"},r.helpPrev=function(){r.step="fifth"},r.prevText={color:"#07bf84"},r.endText="下一步",setTimeout(function(){a.children().attr("style",""),$("help-navigation").show()});break;case"seventh":r.helpBoxClass="seventh",r.textBox={bottom:"100px"},r.helpText=r.isSelectChart?"点击确定返回图册编辑页面":"点击保存，完成图表制作",r.helpEnd=t.isEverLogin?r.closeHelp:r.isSelectChart?r.confirmChart:r.closeHelp,r.prevText={color:"#07bf84"},r.helpPrev=function(){r.step="sixth"},r.endText=t.isEverLogin?"我知道啦":r.isSelectChart?"下一步":"我知道啦",setTimeout(function(){a.children().css("left",$(".chart-edit-bottom").width()/2-88)});break;case"eighth":r.helpBoxClass="eighth",r.textBox={bottom:"100px"},r.helpText="点击确定把图表插入图册",r.helpEnd=t.isEverLogin?r.closeHelp:r.confirm,r.prevText={color:"#07bf84"},r.helpPrev=function(){r.step="seventh"},r.endText=t.isEverLogin?"我知道啦":"下一步";break;case"nineth":r.helpBoxClass="nineth",r.textBox={top:"50px"},r.helpText="点击保存按钮，保存图册",r.helpEnd=function(){r.step="disappear",$("#tipEnd").show()},r.prevText={display:"none"},r.endText="我知道啦";break;case"tenth":r.helpBoxClass="tenth",r.textBox={bottom:"100px"},r.helpText="点击插入图表，海量图表供你使用",r.helpEnd="",r.endText="下一步";break;case"demo":r.helpBoxClass="demo",r.textBox={top:"50px"},r.helpText="点击按钮添加资源框",r.helpEnd=function(){r.addWidgetWithoutPos(),r.step="demoSecond"},r.prevText={display:"none"},r.endText="下一步";break;case"demoSecond":r.helpBoxClass="disappear",r.textBox={bottom:"100px"},r.helpText="点击插入图表，海量图表供你使用",r.helpEnd=r.demoAddChart,r.endText="下一步",r.helpPrev=function(){r.step="demo"},setTimeout(function(){$(".edit-propriety").scrollTop(window.innerHeight);var e=$(".widget-box").last().width()/2+180-10;a.children().css("position","absolute"),a.children().css("left",e),a.children().css("bottom","94px"),a.children().css("display","block")},500);break;case"newSecond":r.helpBoxClass="disappear",r.textBox={bottom:"100px"},r.helpText="点击插入图表，海量图表供你使用",r.helpEnd=r.helpAddChart,r.prevText={display:"none"},r.endText="下一步",setTimeout(function(){var e=$(".gridster-item"),t=0==e.eq(1).length?e.eq(0).height():e.eq(1).height(),r=180+(0==e.eq(1).length?e.eq(0).width():e.eq(1).width())/2,i=20+t/2;a.children().css("position","absolute"),a.children().css("display","block"),a.children().css("left",r+"px"),a.children().css("top",i+"px")},500);break;case"disappear":r.helpBoxClass="disappear";break;case"vip":r.helpBoxClass="vip",r.textBox={bottom:"100px"},r.helpText="充值会员，化身图表大咖~",r.helpEnd=r.closeHelp,r.endText="我知道啦";break;case"profile":r.helpBoxClass="info",r.textBox={bottom:"100px",color:"#58666e"},r.helpText="这里可以你的基本信息哦！",r.helpEnd=r.closeHelp,r.endText="我知道啦"}},r.closeHelp=function(){t.showHelpV3=!1,t.isEverLogin=!0,t.overhelp=!1},r.helpAddChart=function(){i.go("app.chart_instance_dashboard",{chartBookId:r.chartBookData.id,pageIndex:0,widgetIndex:0,curTheme:r.curTheme})},r.demoAddChart=function(){t.showHelpV3=!0,i.go("app.charting_chart_select",{compatVersion:2,bookId:r.chartBookData.id,bookName:r.chartBookData.name,pageIndex:0,widgetIndex:3})}}}}]).directive("draggableBox",["$rootScope","$state","StatisticsService",function(r,i,e){return{restrict:"AE",templateUrl:"tpl/charting/draggableBox.html",scope:"true",link:function(n,e,t){n.$on("draggable:move",function(){n.moveflag=!0}),n.$on("draggable:end",function(e,t){var r=$(".bottom_button"),i=r.position().top,a=window.innerHeight-165;-40<=t.tx&&t.tx<=40&&91<i&&i<a&&r.css("top",i+"px"),n.moveflag=!1});$("#help-button").on("mouseup",function(){n.moveflag||window.open(r.helpServerUrl)}),$("#feedback-button").on("mouseup",function(){n.moveflag||window.open(local_server+"/landing/feedback.html")}),$("#addgroup_button").on("mouseup",function(){n.moveflag||window.open("https://jq.qq.com/?_wv=1027&k=5AEUJtM")}),$("#vip_button").on("mouseup",function(){n.moveflag||i.go("app.vip_intro")})}}}]).directive("iconColorPicker",function(){return{restrict:"A",link:function(t,e,r){t.palette=[["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]],e.spectrum({color:"#000",preferredFormat:"hex",showInput:!1,showInitial:!1,showPalette:!0,palette:t.palette,showSelectionPalette:!0,change:function(e){e=e.toHexString(),t.$emit("iconColorChange",e)}}),$(".sp-cancel").text("取消"),$(".sp-choose").width("50px").text("确定")}}}).controller("selectExistChartCtrl",["$rootScope","$scope","$modalInstance","$timeout","chartInstanceDataManager","chartBookDataManager","themeService",function(r,i,a,e,n,t,o){i.chartInstancesData=[],i.seletChartIndex=0,i.processBgStyle=function(){-1!=i.chartCurTheme.define.background.indexOf("radial-gradient")?(0<navigator.userAgent.indexOf("MSIE")&&(_browserDetect.ie<10?i.bgStyle={background:"#3A3E41"}:i.bgStyle={background:"-ms-"+i.chartCurTheme.define.background}),Object.hasOwnProperty.call(window,"ActiveXObject")&&!window.ActiveXObject&&(i.bgStyle={background:"-ms-"+i.chartCurTheme.define.background}),0<navigator.userAgent.indexOf("Firefox")&&(i.bgStyle={background:"-moz-"+i.chartCurTheme.define.background}),0<navigator.userAgent.indexOf("Chrome")&&(i.bgStyle={background:"-webkit-"+i.chartCurTheme.define.background}),0<navigator.userAgent.indexOf("Opera")&&(i.bgStyle={background:"-o-"+i.chartCurTheme.define.background})):i.bgStyle={background:i.chartCurTheme.define.background}},i.selectExistChart=function(t){i.chartInstanceInfo=i.chartInstancesInfo[t],n.getById(i.chartInstanceInfo.id).then(function(e){i.chartInstancesData[t]=angular.copy(e),i.chartResource=i.chartInstancesData[t].widget.resource,o.queryThemes(i.chartInstancesData[t].id).then(function(e){i.chartTheme=e,i.chartInstancesData[t].curTheme=angular.copy(_.find(i.chartTheme,{id:i.chartInstancesData[t].themeId})),i.chartCurTheme=i.chartInstancesData[t].curTheme,i.chartThemeId=i.chartInstancesData[t].themeId,$("#chart .chart.chartshowid")[0]&&datavizCharts.getInstanceByDom($("#chart .chart.chartshowid")[0])&&datavizCharts.getInstanceByDom($("#chart .chart.chartshowid")[0]).dispose(),i.processBgStyle(),i.$broadcast("drawChart")})}),i.selectChartIndex=t},e(function(){i.selectExistChart(0)}),i.confirm=function(){t.getById(i.chartBookInfo.id).then(function(e){var t=e.pages[i.pageIndex].layout.widget[i.widgetIndex];t.resource=angular.copy(i.chartResource),t.resource.id=UUID.prototype.createUUID(""),t.type="chart",t.props||(t.props={asFilter:!1,notAccept:!1}),r.isSavedToServer=!1,a.dismiss()})},i.dismiss=function(){a.dismiss()}}]);