/*!***********************************************
 Copyright (c) 2019, Neusoft Inc.
 All rights reserved
 图表秀 Version 1.0.0 2020.4.24
 ************************************************/
"use strict";var charting=angular.module("charting",["ngResource","ngCookies","ngFileUpload","weixin-jssdk","ngDraggable","ui.router","ui.bootstrap","common.dvAccordion","dataviz.chartedit.customProperties"]).constant("CHART_V1",1).constant("CHART_V2",2).constant("MEDIA_TYPES",{IMAGE:0,MUSIC:1,ICON:2}).factory("model",function(){return{chartBooksInfo:[{id:"string",originId:"string",ownerId:"string",name:"string",author:"string",category:"string",label:"string",version:"string",originAuthor:"string",modifiedOn:"Date",createdOn:"Date",desc:"string",iconStore:"string",sharing:null}],chartBookData:{id:"1",originId:"string",ownerId:"string",name:"string",author:"string",category:"string",label:"string",version:"string",originAuthor:"string",layoutRatio:1,modifiedOn:"Date",createdOn:"Date",desc:"string",iconStore:"string",isMyCoverImage:!1,iconStoreBase64:"string",themeId:1,background:{image:"string"},options:{showBorder:!1,margin:20},pages:[{index:null,interaction:[{from:"chartId",to:"chartId",type:"click",mapping:{fromField:"a",toField:"b"}}],layout:{id:null,widget:[{define:{sizeX:"number",sizeY:"number",row:"number",col:"number"},type:"chart",resource:{id:1,originId:1,compId:1,name:null,version:null,category:null,desc:null,price:null,author:null,thumbnail:"url",interactive:3,options:[{category:"标题",props:[{title:"content",type:"text",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"margin",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontFamily",type:"checkbox",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontSize",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontWeight",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontColor",type:"color",defaultValue:"xxx",description:"xxx",value:"xxx"}]},{category:"副标题",props:[{title:"content",type:"text",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"margin",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontFamily",type:"checkbox",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontSize",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontWeight",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontColor",type:"color",defaultValue:"xxx",description:"xxx",value:"xxx"}]},{category:"图例",props:[{title:"绑定数据项",type:"text",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"布局",type:"text",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"透明度",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"图例项边距",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"图标形状",type:"list",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"图标宽度",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"图标高度",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"文字宽度",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"文字字号",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"文字字体",type:"list",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"粗斜体",type:"list",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"文字颜色",type:"color",defaultValue:"xxx",description:"xxx",value:"xxx"}]},{category:"提示框",props:[{title:"背景色",type:"color",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"边框宽度",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"边框样式",type:"text",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"圆角半径",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"对齐方式",type:"list",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"文字字号",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"文字字体",type:"list",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"粗斜体",type:"list",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"文字颜色",type:"color",defaultValue:"xxx",description:"xxx",value:"xxx"}]},{category:"其它属性",props:[{title:"content",type:"xxx",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"margin",type:"xxx",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontFamily",type:"xxx",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontSize",type:"xxx",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontWeight",type:"xxx",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontColor",type:"xxx",defaultValue:"xxx",description:"xxx",value:"xxx"}]}],codeStore:"url",userData:[["","Kia","Nissan","Toyota","Honda"],["2008",10,11,12,13],["2009",20,11,14,13],["2010",30,15,12,13]]}},{define:{sizeX:"number",sizeY:"number",row:"number",col:"number"},type:"text",resource:{content:"xxx",fontSize:"xxx",fontFamily:"xxx",fontStyle:"xxx",fontWeight:"xxx",fontColor:"xxx"}},{define:{sizeX:"number",sizeY:"number",row:"number",col:"number"},type:"image",resource:{imageStore:"url"}}]}}],musicMedia:{autoPlay:!1,musicMediaId:"string"}},layoutData:[{id:null,iconStore:null,widget:[{define:{sizeX:"number",sizeY:"number",row:"number",col:"number"}}]}],chartLibrary:[{id:null,name:null,version:null,category:null,desc:null,price:null,author:null,thumbnail:"url",codeStore:"url",interactive:3,crosstabAbility:1,dataCrosstab:1,userData:[["","Kia","Nissan","Toyota","Honda"],["2008",10,11,12,13],["2009",20,11,14,13],["2010",30,15,12,13]]}],categoryData:{chartBookCategory:[{id:0,name:"string"}],chartCategory:[{id:0,name:"string"}]}}}).factory("chartBooksInfoResource",["$resource",function(e){return e(charts_server+"/service/charting/chartbooksinfo/all",{},{query:{method:"GET",isArray:!1}})}]).factory("chartBookDataResource",["$resource",function(e){return e(charts_server+"/service/charting/chartbookdata/:id",{},{update:{method:"PUT",params:{u:"@u"},isArray:!1}})}]).factory("layoutResource",["$resource",function(e){return e(charts_server+"/service/charting/layoutdata/",{},{query:{method:"GET",isArray:!1}})}]).factory("chartLibraryResource",["$resource",function(e){return e(charts_server+"/service/charting/chartlibrary/",{},{query:{method:"GET",isArray:!1}})}]).factory("chartLibraryResourceV2",["$resource",function(e){return e(charts_server+"/service/charting/chartlibrary_v2",{},{query:{method:"GET",isArray:!1}})}]).factory("categoryResource",["$resource",function(e){return e(charts_server+"/service/charting/categorydata/",{},{query:{method:"GET",isArray:!1}})}]).factory("categoryResourceV2",["$resource",function(e){return e(charts_server+"/service/charting/categorydata_v2",{},{query:{method:"GET",isArray:!1}})}]).factory("favoritesResource",["$resource",function(e){return e(charts_server+"/service/social/favorites/chartbooksinfo",{},{query:{method:"GET",isArray:!1},remove:{method:"DELETE",url:charts_server+"/service/social/favorite/:chartBookIds"}})}]).factory("shareBooksInfoResource",["$resource",function(e){return e(charts_server+"/service/",{},{query:{method:"GET",isArray:!1},queryshare:{method:"GET",url:charts_server+"/service/charting/sharewebsite/:chartBookIds"}})}]).factory("chartBooksInfoManager",["chartBooksInfoResource","favoritesResource","shareBooksInfoResource","$q","model",function(e,t,o,a,r){var n=r.chartBooksInfo;return{query:function(){var t=a.defer();return e.query(function(e,r){e.error?t.reject(e.error):(n=e.object,t.resolve(n))},function(e,r){t.reject(e)}),t.promise},queryFavorites:function(){var r=a.defer();return t.query(function(e){e.error?r.reject(e.error):r.resolve(e.object)},function(e){r.reject(e)}),r.promise},removeFavorite:function(e){var r=a.defer();return t.remove({chartBookIds:e},function(e){e&&e.error?r.reject(e.error):r.resolve()},function(e){r.reject(e)}),r.promise},querysharing:function(e){var r=a.defer();return o.queryshare({chartBookIds:e},function(e){e&&e.error?r.reject(e.error):r.resolve(e.object)},function(e){r.reject(e)}),r.promise}}}]).factory("chartBookDataSortManager",["chartBooksInfoResource","$q","model",function(e,u,r){var s=r.chartBookData;return{sort:function(e){for(var r,t,o=u.defer(),a=s.pages,n=a.length,i=e.split(","),c=0;c<n;c++)if(c!=i[c]){t=i[r=c],a[r]=a.splice(t,1,a[r])[0];break}return o.resolve(),o.promise}}}]).factory("chartBookDataManager",["chartBookDataResource","MediaLibraryManager","$http","$q","model",function(r,n,i,c,u){var s=u.chartBookData;return{getById:function(e){var t=c.defer();return s.id==e?t.resolve(s):r.get({id:e},function(e,r){e.error?t.reject(e.error):(s=e.object,_.each(s.pages,function(e){_.each(e.layout.widget,function(e){if("chart"===e.type){var r=e.resource.userData;e.resource.userData=JSON.parse(r)}})}),u.chartBookData=s,t.resolve(s))},function(e,r){t.reject(e)}),t.promise},create:function(){var t=c.defer();return r.save({},function(e,r){e.error?t.reject(e.error):(s=e.object,t.resolve(s))},function(e,r){t.reject(e)}),t.promise},update:function(t,e,o){var a=c.defer();return r.update({u:e},t,function(e,r){e.error?a.reject(e.error):(o?(n.clearRefCount(),t.isMyCoverImage&&t.iconStore&&n.increaseRefCount(t.iconStore),t.musicMediaSaved&&t.musicMediaSaved.musicMediaSelect&&t.musicMediaSaved.musicMediaSelect.musicPath&&n.increaseRefCount(t.musicMediaSaved.musicMediaSelect.musicPath),i({method:"POST",url:charts_server+"/service/charting/resource/book/getlogoimg",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},data:"chartbook_id="+t.id}).then(function(e){var r=angular.copy(e.data.object);r&&n.increaseRefCount(r),_.each(t.pages,function(e){e.options&&e.options.backgroundImage&&n.increaseRefCount(e.options.backgroundImage),e.options&&e.options.backgroundImageMobile&&n.increaseRefCount(e.options.backgroundImageMobile),_.each(e.layout.widget,function(e){"image"===e.type&&n.increaseRefCount(e.resource.imageStore)})}),n.updateRefCounts()})):n.updateRefCounts(),s=t,u.chartBookData=t,e.object?a.resolve(e.object):a.resolve())},function(e,r){a.reject(e)}),a.promise},delete:function(e){var o=c.defer();return r.delete({id:e},function(e,r){if(e.error)o.reject(e.error);else{var t=e.object;n.clearRefCount(),_.each(t,function(t){t.isMyCoverImage&&t.iconStore&&n.decreaseRefCount(t.iconStore),t.musicMediaSaved&&t.musicMediaSaved.musicMediaSelect&&t.musicMediaSaved.musicMediaSelect.musicPath&&n.decreaseRefCount(t.musicMediaSaved.musicMediaSelect.musicPath),i({method:"POST",url:charts_server+"/service/charting/resource/book/getlogoimg",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},data:"chartbook_id="+t.id}).then(function(e){var r=angular.copy(e.data.object);r&&n.decreaseRefCount(r),_.each(t.pages,function(e){e.options&&e.options.backgroundImage&&n.decreaseRefCount(e.options.backgroundImage),e.options&&e.options.backgroundImageMobile&&n.decreaseRefCount(e.options.backgroundImageMobile),_.each(e.layout.widget,function(e){"image"===e.type&&n.decreaseRefCount(e.resource.imageStore)})}),n.updateRefCounts()})}),o.resolve()}},function(e,r){o.reject(e)}),o.promise}}}]).factory("layoutManager",["layoutResource","$q","model",function(e,r,t){var o=t.layoutData;return{getById:function(e){return _.findWhere(o,{id:e})},query:function(){var t=r.defer();return e.query(function(e,r){o=e.object,t.resolve(o)},function(e,r){t.reject(e)}),t.promise}}}]).factory("chartLibraryManager",["chartLibraryResource","chartLibraryResourceV2","categoryManager","CHART_V1","CHART_V2","$q","model","$http","$rootScope",function(r,o,a,n,i,c,u,e,s){var d=[],l=i;return{getById:function(e,r){var t=c.defer(),o=null;!r||r==l&&0!==d.length?(o=_.findWhere(d,l==n?{id:e}:{compId:e}),l===i?f(o).then(function(e){x(e).then(function(e){t.resolve(e)})}):t.resolve(o)):this.query(r).then(function(){o=_.findWhere(d,l==n?{id:e}:{compId:e}),l===i&&f(o).then(function(e){x(e).then(function(e){t.resolve(e)})})});return t.promise},query:function(e){var t=c.defer();if(d&&0<d.length&&l==e)t.resolve(d);else switch(e){case n:r.query(function(e,r){e.error?t.reject(e.error):(d=e.object,_.each(d,function(e){e.userData=JSON.parse(e.userData)}),u.chartLibrary=d,l=n,t.resolve(d))},function(e,r){t.reject(e)});break;case i:a.query(i).then(function(e){o.query(function(e,r){if(e.error)t.reject(e.error);else{d=e.object,u.chartLibrary=e,l=i;_.each(d,function(e){s.userinfo.limit.isfullcharts&&e.onSale&&(e.chartOwning?e.chartOwning.isExpired&&(e.chartOwning.isExpired=!1):e.chartOwning={isExpired:!1}),t.resolve(d)})}},function(e,r){t.reject(e)})})}return t.promise}};function f(r){var t=c.defer();return r.simpleJson?t.resolve(r):e({method:"get",url:"assets/chart/json/"+r.compId+"/1_0/simple.json"}).then(function(e){e.data.error?console.error("getting chart json failed, compId: "+r.compId):(r.simpleJson=e.data,t.resolve(r))}),t.promise}function x(r){var t=c.defer();return r.userData?t.resolve(r):e({method:"get",url:"assets/chart/sample/"+r.compId+"/1_0/sampleData.json"}).then(function(e){e.data.error?console.error("getting chart sample data failed, compId: "+r.compId):(r.userData=e.data,t.resolve(r))}),t.promise}}]).factory("categoryManager",["categoryResource","categoryResourceV2","CHART_V1","CHART_V2","$q","model",function(r,o,a,n,i,c){var u={chartBookCategory:[],chartCategory:[]},s=n;return{getChartCategoryById:function(e){return _.findWhere(u.chartCategory,{id:e})},getChartBookCategoryById:function(e){return _.findWhere(u.chartBookCategory,{id:e})},query:function(e){var t=i.defer();if(u&&0<u.chartCategory.length&&s==e)t.resolve(u);else switch(e){case a:r.query(function(e,r){e.error?t.reject(e.error):(u=e.object,s=a,c.categoryData=e.object,t.resolve(u))},function(e,r){t.reject(e)});break;case n:o.query(function(e,r){e.error?t.reject(e.error):(u=e.object,s=n,c.categoryData=e.object,t.resolve(u))},function(e,r){t.reject(e)})}return t.promise}}}]).factory("userDataService",function(){function f(e){return"number"==typeof e||/^-?(\d+\.?,?)*\d+%?$/.test(e)}return{array2json:function(e,r){var t=[];if(angular.isArray(e)){if(e[0]&&void 0!==e[0][0])if(r)for(var o=1,a=e.length;o<a;o++)for(var n=1,i=e[0].length;n<i;n++){(c={})["列标题"]=e[0][n],c["行标题"]=e[o][0],c["数据值"]=e[o][n],t.push(c)}else for(o=1,a=e.length;o<a;o++){var c={};for(n=0,i=e[0].length;n<i;n++)c[e[0][n]]=e[o][n];t.push(c)}else t=e;return t}},cross2list:function(e,r,t){var o=[];if(r){e._header=e._header||"vertical"===t?["行标题","列标题","数据值"]:["列标题","行标题","数据值"],o.push(e._header);for(var a=1,n=e.length;a<n;a++)for(var i=1,c=e[0].length;i<c;i++){var u=[];"vertical"===t?(u.push(e[a][0]),u.push(e[0][i])):(u.push(e[0][i]),u.push(e[a][0])),u.push(e[a][i]),o.push(u)}r=0}else{var s,d,l=1,f=1,x=[],h=[];o._header=e[0],o[l]=[],o[0]=[],o[0][0]="";for(a=1,n=e.length;a<n;a++)for(i=0,c=e[0].length;i<c;i++)0==i?null==o[0][f]?(o[0][f]=e[a][i])&&h.push(e[a][i]):-1!=(d=_.indexOf(h,e[a][i]))?f=d+1:(f=h.length+1)&&(o[0][f]=e[a][i])&&h.push(e[a][i]):1==i?null==o[l][0]?(o[l][0]=e[a][i])&&x.push(e[a][i]):-1!=(s=_.indexOf(x,e[a][i]))?l=s+1:(l=x.length+1)&&(o[l]=[])&&(o[l][0]=e[a][i])&&x.push(e[a][i]):null!==e[a][i]&&(o[l][f]=e[a][i]);r=1}return{newData:o,dataCrosstab:r}},judgeCrossTab:function(e){return!!e.length&&!e[0][0]},transposeJsonArray:function(e){if(0===e.length)return[];for(var r=[],t=0;t<e[0].length;t++){for(var o=[],a=0;a<e.length;a++)o.push(e[a][t]);r.push(o)}return r},determineDataAndDirection:function(e){if(e&&e.length){var r=(e=function(e){if(!e.length||!e[0].length)return e;for(var r=JSON.parse(JSON.stringify(e)),t=0;t<r.length;t++)if(""===r[t][0]){for(var o=!0,a=1;a<r[t].length;a++)if(""!==r[t][a]){o=!1;break}if(o)break}t<r.length&&(r=r.slice(0,t));if(0===r.length)return[[]];for(var n=0;n<r[0].length;n++)if(""===r[0][n]){for(o=!0,a=1;a<r.length;a++)if(""!==r[a][n]){o=!1;break}if(o)break}if(n<r[0].length)for(a=0;a<r.length;a++)r[a]=r[a].slice(0,n);return r}(e)).length,t=e[0].length,o={};if(1===r&&1===t)o={top:0,bottom:0,left:0,right:0};else if(e[0][0])if(f(e[r-1][t-1])){o.bottom=r-1,o.right=t-1;for(var a=r-2;0<=a&&f(e[a][t-1]);a--);o.top=++a;for(var n=t-2;0<=n&&f(e[r-1][n]);n--);o.left=++n}else o={top:r-1,bottom:r-1,left:t-1,right:t-1};else{o.bottom=r-1,o.right=t-1;for(n=1;n<t&&!e[0][n];n++);o.left=n;for(a=1;a<r&&!e[a][n-1];a++);o.top=a}var i="horizontal";if(1===e.length)i="horizontal";else if(1===e[0].length)i="vertical";else{var c=o.bottom-o.top+1,u=o.right-o.left+1;i=c==u?e.length<=e[0].length||e[0][0]?"horizontal":"vertical":u<c?"vertical":"horizontal"}if(1<(e._valueBoundary=o).top||1<o.left){for(var s=!0,d=0;d<o.top;d++){for(var l=0;l<o.left;l++)if(e[d][l]){s=!1;break}if(!s)break}s&&(e=this.mergeHeaders(e))}e[0][0]&&!/^\s*$/g.test(e[0][0])||(e[0][0]="分类名")}else e=[[]];return{data:e,orientation:i}},mergeHeaders:function(e){var r=e._valueBoundary;if(r){if(1<r.top){for(var t=[],o=0;o<e[0].length;o++)if(o<r.left)t.push("");else{for(var a=[],n=0;n<r.top;n++)a.push(e[n][o]);t.push(a.join(" "))}e.splice(0,r.top,t),r.top=1}if(1<r.left){for(o=0;o<e.length;o++){for(a=[],n=0;n<r.left;n++)a.push(e[o][n]);e[o].splice(0,r.left,a.join(" "))}r.left=1}}return e}}}).factory("interactionService",["chartBookDataManager","userDataService","model","$rootScope",function(r,u,e,s){var d=d3.map(),l=d3.map(),t=[];return{registerInteraction:function(e){r.getById(e).then(function(e){var r=e.pages;t.forEach(function(e){chartsshow.message.unsubscribe(e),t.pop(e)}),r.forEach(function(e){var r=e.interaction;e.layout.widget.forEach(function(e){"chart"==e.type&&(d.remove(e.resource.id),d.set(e.resource.id,e.resource.userData),l.remove(e.resource.id),l.set(e.resource.id,e.resource.dataCrosstab))}),r&&r.forEach(function(c,e){var r=c.from+"_click";t.push(r),chartsshow.message.subscribe(r,function(e){var r=e[c.mapping.fromField];if(r){var t=d.get(c.to),o=l.get(c.to),a=u.array2json(t,o),n={};n[c.mapping.toField]=r;var i=_.where(a,n);s.$broadcast("interactiveChart",{id:c.to,data:i})}})})})})},checkInteraction:function(e){d.remove(e)},refreshCharts:function(e){e.layout.widget.forEach(function(e){if("chart"==e.type){var r=d.get(e.resource.id),t=l.get(e.resource.id),o=u.array2json(r,t);s.$broadcast("interactiveChart",{id:e.resource.id,data:o})}})}}}]).factory("chartCodeCache",function(){return d3.map()}).factory("imgService",["$q","$http",function(d,l){return{generateImg:function(e,r,t,o,a,n,i){var c=d.defer(),u={};u.path=e,u.SERVERID=r,u.pageCount=t,u.chartBookId=o,u.exportWidth=a,u.exportHeight=n,u.exportHDImage=i;var s={url:charts_server+"/service/export/imgs/",method:"post",params:u};return l(s).then(function(e){e.data.error?c.reject(e.data.error):c.resolve(e.data.object)},function(e){c.reject(e)}),c.promise}}}]).factory("chartCleanManager",["$rootScope","$interval",function(o,e){e(function(){!function(){o.ChartCache=o.ChartCache||[];for(var e=o.ChartCache.length-1;0<=e;e--)document.getElementById(o.ChartCache[e].domId)||(window.echarts.getInstanceById(o.ChartCache[e].echartId)&&window.echarts.getInstanceById(o.ChartCache[e].echartId).dispose(),o.ChartCache.splice(e,1))}()},3e4);return{storeChart:function(e,r){o.ChartCache=o.ChartCache||[];var t=r[0].getAttribute("_echarts_instance_");t&&o.ChartCache.push({domId:e,echartId:t})}}}]).factory("pdfService",["$resource","$http","$q",function(e,n,i){return{generatePdf:function(e,r,t,o){var a=i.defer();return n.get(charts_server+"/service/export/pdf",{params:{path:e,SERVERID:r,exportWidth:t,exportHeight:o}}).then(function(e){e.data.error?a.reject(e.data.error):a.resolve(e.data.object)},function(e){a.reject(e)}),a.promise}}}]).factory("pdfManager",["chartBookDataManager","pdfService","imgService","$q","$http",function(e,s,l,f,x){return{exportPdf:function(e,c,r,t){var u=f.defer(),o=local_server+"/export.html?print-pdf="+e,a="";if(0<document.cookie.length){var n=document.cookie.indexOf("SERVERID=");if(-1!=n){n+=9;var i=document.cookie.indexOf(";",n);-1==i&&(i=document.cookie.length),a=document.cookie.substring(n,i)}}return s.generatePdf(o,a,r,t).then(function(e){e.error&&u.reject("err");var r=!1;(0<navigator.userAgent.indexOf("MSIE")||0<navigator.userAgent.indexOf("rv:11.0"))&&(r=!0);var t=charts_server+"/service/export/gpdf",o=document.createElement("form");o.action=t,o.target="_self",o.method="post";var a=document.createElement("input");a.type="hidden",a.name="path",a.value=e,o.appendChild(a);var n=document.createElement("input");n.type="hidden",n.name="isIe",n.value=r,o.appendChild(n);var i=document.createElement("input");i.type="hidden",i.name="exportName",i.value=c,o.appendChild(i),document.body.appendChild(o),o.submit(),document.body.removeChild(o),u.resolve(e)}),u.promise},exportImgs:function(e,r,t){var o=f.defer(),a=local_server+"/export.html?print-pdf="+e,n=$(".whRatioDiv:first"),i=n[0].clientWidth/n[0].clientHeight;$(".whRatioDiv").each(function(e,r){var t=r.clientWidth/r.clientHeight;t<i&&(i=t)});var c="";if(0<document.cookie.length){var u=document.cookie.indexOf("SERVERID=");if(-1!=u){u+=9;var s=document.cookie.indexOf(";",u);-1==s&&(s=document.cookie.length),c=document.cookie.substring(u,s)}}var d={};d.path=a,d.ratios=i,d.SERVERID=c,d.pageCount=r,d.chartbookId=e,d.width=t;var l={url:charts_server+"/service/export/imgs/",method:"post",params:d};return x(l).then(function(e){e.error&&o.reject("err"),o.resolve("success")},function(e){o.reject("err")}),o.promise},exportImgsZip:function(c,u,s,e,r,t){var d=f.defer(),o=local_server+"/export.html?print-img="+c,a="";if(0<document.cookie.length){var n=document.cookie.indexOf("SERVERID=");if(-1!=n){n+=9;var i=document.cookie.indexOf(";",n);-1==i&&(i=document.cookie.length),a=document.cookie.substring(n,i)}}return l.generateImg(o,a,u,c,e,r,t).then(function(e){if(e.error&&d.reject("err"),1<u){var r=charts_server+"/service/export/getimgszip";(o=document.createElement("form")).action=r,o.target="_self",o.method="post",(a=document.createElement("input")).type="hidden",a.name="code",a.value=c,o.appendChild(a),document.body.appendChild(o),o.submit(),document.body.removeChild(o),d.resolve("success")}else{var t=!1;(0<navigator.userAgent.indexOf("MSIE")||0<navigator.userAgent.indexOf("rv:11.0"))&&(t=!0);var o,a;r=charts_server+"/service/export/saveimg";(o=document.createElement("form")).action=r,o.target="_self",o.method="post",(a=document.createElement("input")).type="hidden",a.name="code",a.value=c,o.appendChild(a);var n=document.createElement("input");n.type="hidden",n.name="exportName",n.value=s,o.appendChild(n);var i=document.createElement("input");i.type="hidden",i.name="isIe",i.value=t,o.appendChild(i),document.body.appendChild(o),o.submit(),document.body.removeChild(o),d.resolve("success")}},function(e){d.reject("err")}),d.promise},exportPpt:function(a,e,r,t){var n=f.defer(),o=local_server+"/export.html?print-pdf="+a,i="";if(0<document.cookie.length){var c=document.cookie.indexOf("SERVERID=");if(-1!=c){c+=9;var u=document.cookie.indexOf(";",c);-1==u&&(u=document.cookie.length),i=document.cookie.substring(c,u)}}return l.generateImg(o,i,e,a,r,t,!1).then(function(e){e.error&&n.reject("err");var r=charts_server+"/service/export/getppt",t=document.createElement("form");t.action=r,t.target="_self",t.method="post";var o=document.createElement("input");o.type="hidden",o.name="code",o.value=a,t.appendChild(o),document.body.appendChild(t),t.submit(),document.body.removeChild(t),n.resolve("success")},function(e){n.reject("err")}),n.promise},exportHtmlZip:function(e){var r=f.defer(),t=!1;(0<navigator.userAgent.indexOf("MSIE")||0<navigator.userAgent.indexOf("rv:11.0"))&&(t=!0);var o=charts_server+"/service/export/gethtmlzip",a=document.createElement("form");a.action=o,a.target="_self",a.method="post";var n=document.createElement("input");n.type="hidden",n.name="file",n.value=e,a.appendChild(n);var i=document.createElement("input");return i.type="hidden",i.name="isIe",i.value=t,a.appendChild(i),document.body.appendChild(a),a.submit(),document.body.removeChild(a),r.promise},exportHtmlSingle:function(e,r){var t=f.defer(),o=!1;(0<navigator.userAgent.indexOf("MSIE")||0<navigator.userAgent.indexOf("rv:11.0"))&&(o=!0);var a=charts_server+"/service/export/gethtmlsingle",n=document.createElement("form");n.action=a,n.target="_self",n.method="post";var i=document.createElement("input");i.type="hidden",i.name="file",i.value=e,n.appendChild(i);var c=document.createElement("input");c.type="hidden",c.name="isIe",c.value=o,n.appendChild(c);var u=document.createElement("input");return u.type="hidden",u.name="filesToLoad",u.value=r.join(","),n.appendChild(u),document.body.appendChild(n),n.submit(),document.body.removeChild(n),t.promise}}}]).factory("chartEngineManager",["$ocLazyLoad","$timeout","$q","CHART_V1","CHART_V2",function(d,e,l,f,x){return{chartClusters:r,loadEngine:function(e,r,t){var o=l.defer(),a="",n="js/charts_v1/datavizjs/dataviz/dataviz.config.js";r&&(a="src/",n="js/charts_v1/datavizjs/dataviz/play.dataviz.config.js");switch(e){case f:if("undefined"==typeof echarts||"2.2.7"!==echarts.version){if($("#loading-mask").show(),"undefined"!=typeof define){var i=define;define=void 0}if("undefined"!=typeof require){var c=require;require=void 0}if("undefined"!=typeof requirejs){var u=requirejs;requirejs=void 0}return d.load([{files:[a+"js/charts_v1/chartsshow-93701d999b.js"],cache:!0},{files:[a+"js/charts_v1/echarts/echarts-all-d1d7171439.js",a+"js/charts_v1/echarts/option-b74c45db64.js",a+"../bower_components/requirejs/require.js",a+n],cache:!1,serie:!0}]).then(function(){"undefined"==typeof define&&(define=i),"undefined"==typeof require&&(require=c),"undefined"==typeof requirejs&&(requirejs=u),u=c=i=void 0,$("#loading-mask").hide(),o.resolve()})}o.resolve();case x:if("undefined"==typeof datavizCharts){var s=function(e,r){var t=cas_server&&cas_server.length,o=[],a={engine_v2_base:{pro_path:["js/chartPro/dvChartConfig.js","js/chartPro/vendor.js","js/chartPro/dvCharts.js"],dev_path:["js/chartDev/dvChartConfig.js","js/chartDev/vendor.js","js/chartDev/dvCharts.js"]}},n="undefined"==typeof echarts||"2.2.7"===echarts.version,i=r?"src/":"";if(r||n)for(var c in a)(n&&"engine_v2_base"===c||!e||a.hasOwnProperty(c)&&_.intersection(a[c].compIds,e).length)&&_.each(t?a[c].pro_path:a[c].dev_path,function(e){o.push(i+e)});return o}(t,r);if(s.length){if($("#loading-mask").show(),"undefined"!=typeof define){i=define;define=void 0}if("undefined"!=typeof require){c=require;require=void 0}if("undefined"!=typeof requirejs){u=requirejs;requirejs=void 0}return d.load([{files:s,cache:!1,serie:!0}]).then(function(){"undefined"==typeof define&&(define=i),"undefined"==typeof require&&(require=c),"undefined"==typeof requirejs&&(requirejs=u),u=c=i=void 0,$("#loading-mask").hide(),o.resolve()})}o.resolve()}else o.resolve()}return o.promise}};function r(){return{engine_v2_base:{pro_path:["js/chartPro/dvChartConfig.js","js/chartPro/vendor.js","js/chartPro/dvCharts.js"],dev_path:["js/chartDev/dvChartConfig.js","js/chartDev/vendor.js","js/chartDev/dvCharts.js"]}}}}]);